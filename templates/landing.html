{% extends 'base.html' %}

{% block title %}iZwi - Community Alerts{% endblock %}

{% block content %}
<div class="flex flex-col min-h-screen">
  <main class="flex-grow">
    <div class="px-4 py-8 md:py-12">
      <div class="container mx-auto max-w-4xl">
        <!-- Header Section -->
        <div class="text-center mb-8">
          <h1 class="font-display font-semibold text-3xl md:text-4xl text-gray-900 dark:text-white leading-tight mb-4">
            {% if invite %}Join Your Community{% else %}Create Your Community{% endif %}
          </h1>
          <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
            {% if invite %}Welcome! You're invited to join an existing community. Enter your details below to get started.{% else %}Start building your local alert network. Connect with neighbors and stay informed about what's happening in your area.{% endif %}
          </p>
        </div>

        <!-- Progress Steps (only show for new community creation) -->
        {% if not invite %}
        <div class="mb-8">
          <div class="flex items-center justify-center space-x-4">
            <div class="flex items-center">
              <div class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
              <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Account</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
            <div class="flex items-center">
              <div class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
              <span class="ml-2 text-sm font-medium text-gray-500">Community</span>
            </div>
            <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
            <div class="flex items-center">
              <div class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
              <span class="ml-2 text-sm font-medium text-gray-500">Welcome</span>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="flex flex-col lg:flex-row items-start gap-8 lg:gap-12">
          <!-- Left side - Visual/Info -->
          <div class="w-full lg:w-2/5">
            <div class="bg-gradient-to-br from-primary/10 to-primary/20 rounded-xl p-6 mb-6">
              <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center mr-3">
                  <span class="text-primary text-lg">üèòÔ∏è</span>
                </div>
                <div>
                  <h3 class="font-semibold text-gray-900 dark:text-white">Community Benefits</h3>
                  <p class="text-sm text-gray-600 dark:text-gray-300">What you'll get</p>
                </div>
              </div>
              <ul class="space-y-3 text-sm">
                <li class="flex items-start">
                  <span class="text-primary mr-2 mt-0.5">‚úÖ</span>
                  <span class="text-gray-700 dark:text-gray-200">Real-time community alerts</span>
                </li>
                <li class="flex items-start">
                  <span class="text-primary mr-2 mt-0.5">‚úÖ</span>
                  <span class="text-gray-700 dark:text-gray-200">Connect with local neighbors</span>
                </li>
                <li class="flex items-start">
                  <span class="text-primary mr-2 mt-0.5">‚úÖ</span>
                  <span class="text-gray-700 dark:text-gray-200">Stay informed about local events</span>
                </li>
                <li class="flex items-start">
                  <span class="text-primary mr-2 mt-0.5">‚úÖ</span>
                  <span class="text-gray-700 dark:text-gray-200">Free to use forever</span>
                </li>
              </ul>
            </div>

            {% if invite %}
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6">
              <div class="flex items-center mb-3">
                <span class="text-blue-500 text-lg mr-2">üîó</span>
                <h3 class="font-semibold text-gray-900 dark:text-white">Community Invitation</h3>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-300">
                You're joining <strong class="text-gray-900 dark:text-white">{{ invite.community_name }}</strong>.
                Welcome to the community!
              </p>
            </div>
            {% endif %}
          </div>

          <!-- Right side - Form -->
          <div class="w-full lg:w-3/5">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
              <form method="POST" action="{{ url_for('signup_submit') }}" class="space-y-5" autocomplete="on">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Name Field -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="name">
                    What's your name? *
                  </label>
                  <input class="input w-full" id="name" name="name" placeholder="Enter your full name" type="text" autocomplete="nickname" required/>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This is how other community members will see you</p>
                </div>

                <!-- Email Field -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="email">
                    Email address *
                  </label>
                  <input class="input w-full" id="email" name="email" placeholder="your.email@example.com" type="email" autocomplete="username email" required aria-label="Email address"/>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">We'll use this to send you important community updates</p>
                </div>

                <!-- Password Field -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="password">
                    Create a password *
                  </label>
                  <div class="relative">
                    <input class="input w-full pl-10 pr-12" id="password" name="password" placeholder="Choose a strong password" type="password" autocomplete="new-password" required aria-label="Password"/>
                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm pointer-events-none">
                      üîí
                    </div>
                    <button type="button" onclick="togglePasswordVisibility('password')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                      <span class="material-symbols-outlined text-lg" id="password-toggle-icon">visibility_off</span>
                    </button>
                  </div>
                  <div class="mt-3 space-y-2">
                    <div class="flex items-center text-xs">
                      <span id="length-check" class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200">‚óã</span>
                      <span class="transition-colors duration-200">At least 8 characters</span>
                    </div>
                    <div class="flex items-center text-xs">
                      <span id="uppercase-check" class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200">‚óã</span>
                      <span class="transition-colors duration-200">One uppercase letter</span>
                    </div>
                    <div class="flex items-center text-xs">
                      <span id="number-check" class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200">‚óã</span>
                      <span class="transition-colors duration-200">One number</span>
                    </div>
                    <div class="flex items-center text-xs">
                      <span id="strength-meter" class="w-4 h-4 rounded-full flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200">‚óã</span>
                      <span class="transition-colors duration-200">Strong password</span>
                    </div>
                  </div>
                </div>

                <!-- Consent Checkbox -->
                <div class="pt-2">
                  <div class="flex items-start gap-3">
                    <input type="checkbox" name="consent" id="consent" required class="mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2">
                    <label for="consent" class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                      I agree to the <a href="{{ url_for('terms_of_service') }}" class="text-primary hover:text-primary/80 underline font-medium" target="_blank">Terms of Service</a> and <a href="{{ url_for('privacy_policy') }}" class="text-primary hover:text-primary/80 underline font-medium" target="_blank">Privacy Policy</a> *
                    </label>
                  </div>
                </div>

                <!-- Submit Button -->
                <button id="signup-btn" class="btn btn-primary w-full h-12 text-base font-semibold transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50" type="submit">
                  <span class="btn-text">{% if invite %}Join {{ invite.community_name }}{% else %}Create My Community{% endif %}</span>
                  <span class="btn-loading hidden flex items-center justify-center gap-2">
                    <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    {% if invite %}Joining...{% else %}Creating...{% endif %}
                  </span>
                </button>

                <!-- Login Link -->
                <div class="text-center pt-2">
                  <span class="text-gray-500 dark:text-gray-400 text-sm">Already have an account?</span>
                  <a href="{{ url_for('login') }}" class="text-primary hover:text-primary/80 font-medium ml-2">Sign In</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-background-light dark:bg-background-dark py-4">
    <div class="container mx-auto text-center text-sm text-gray-500 dark:text-gray-400">
      <div class="flex flex-wrap justify-center gap-4 mb-2">
        <a href="{{ url_for('privacy_policy') }}" class="hover:text-primary transition-colors">Privacy Policy</a>
        <span>‚Ä¢</span>
        <a href="{{ url_for('terms_of_service') }}" class="hover:text-primary transition-colors">Terms of Service</a>
      </div>
      ¬© 2024 iZwi. All rights reserved.
    </div>
  </footer>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('signup-btn');
  const passwordInput = document.getElementById('password');

  if (!form || !submitBtn) return;

  // Enhanced password strength checker
  if (passwordInput) {
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      updatePasswordStrength(password);
    });

    passwordInput.addEventListener('focus', function() {
      // Show password requirements on focus
      this.closest('.relative').nextElementSibling.classList.remove('hidden');
    });
  }

  function updatePasswordStrength(password) {
    const lengthCheck = document.getElementById('length-check');
    const uppercaseCheck = document.getElementById('uppercase-check');
    const numberCheck = document.getElementById('number-check');
    const strengthMeter = document.getElementById('strength-meter');

    // Check length (8+ characters)
    const hasLength = password.length >= 8;
    updateCheckElement(lengthCheck, hasLength, '‚úì', '‚óã');

    // Check uppercase letter
    const hasUppercase = /[A-Z]/.test(password);
    updateCheckElement(uppercaseCheck, hasUppercase, '‚úì', '‚óã');

    // Check number
    const hasNumber = /\d/.test(password);
    updateCheckElement(numberCheck, hasNumber, '‚úì', '‚óã');

    // Check overall strength
    const strength = calculatePasswordStrength(password);
    updateStrengthMeter(strengthMeter, strength);

    // Update input border color based on strength
    const input = passwordInput.closest('.relative').querySelector('input');
    if (password.length === 0) {
      input.classList.remove('border-red-500', 'border-yellow-500', 'border-green-500');
    } else if (strength >= 3) {
      input.classList.remove('border-red-500', 'border-yellow-500');
      input.classList.add('border-green-500');
    } else if (strength >= 2) {
      input.classList.remove('border-red-500', 'border-green-500');
      input.classList.add('border-yellow-500');
    } else {
      input.classList.remove('border-yellow-500', 'border-green-500');
      input.classList.add('border-red-500');
    }
  }

  function updateCheckElement(element, isValid, validSymbol, invalidSymbol) {
    if (isValid) {
      element.innerHTML = validSymbol;
      element.className = 'w-4 h-4 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200';
      element.nextElementSibling.classList.remove('text-gray-400');
      element.nextElementSibling.classList.add('text-green-600');
    } else {
      element.innerHTML = invalidSymbol;
      element.className = 'w-4 h-4 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200';
      element.nextElementSibling.classList.remove('text-green-600');
      element.nextElementSibling.classList.add('text-gray-400');
    }
  }

  function calculatePasswordStrength(password) {
    let strength = 0;

    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^A-Za-z\d]/.test(password)) strength++;

    return strength;
  }

  function updateStrengthMeter(element, strength) {
    const colors = ['bg-gray-200 text-gray-400', 'bg-red-200 text-red-600', 'bg-yellow-200 text-yellow-600', 'bg-green-200 text-green-600', 'bg-green-400 text-green-800', 'bg-green-600 text-white'];

    if (strength >= 4) {
      element.innerHTML = '‚úì';
      element.className = `w-4 h-4 rounded-full ${colors[5]} flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200`;
      element.nextElementSibling.classList.remove('text-gray-400');
      element.nextElementSibling.classList.add('text-green-600');
    } else if (strength >= 3) {
      element.innerHTML = '~';
      element.className = `w-4 h-4 rounded-full ${colors[4]} flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200`;
      element.nextElementSibling.classList.remove('text-gray-400');
      element.nextElementSibling.classList.add('text-green-600');
    } else if (strength >= 2) {
      element.innerHTML = '~';
      element.className = `w-4 h-4 rounded-full ${colors[3]} flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200`;
      element.nextElementSibling.classList.remove('text-gray-400');
      element.nextElementSibling.classList.add('text-yellow-600');
    } else {
      element.innerHTML = '‚óã';
      element.className = `w-4 h-4 rounded-full ${colors[0]} flex items-center justify-center text-xs font-bold mr-2 transition-all duration-200`;
      element.nextElementSibling.classList.remove('text-green-600', 'text-yellow-600');
      element.nextElementSibling.classList.add('text-gray-400');
    }
  }

  // Form submission handling
  const btnText = submitBtn.querySelector('.btn-text');
  const btnLoading = submitBtn.querySelector('.btn-loading');

  form.addEventListener('submit', function() {
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    if (btnText) btnText.classList.add('hidden');
    if (btnLoading) btnLoading.classList.remove('hidden');
  });

  // Enhanced form field animations and interactions
  const inputs = form.querySelectorAll('input');
  inputs.forEach(input => {
    // Add focus animations
    input.addEventListener('focus', function() {
      const parent = this.closest('.relative') || this.parentElement;
      parent.classList.add('ring-2', 'ring-primary/30', 'transform', 'scale-[1.02]');
      parent.classList.remove('scale-100');

      // Add floating label effect if it exists
      const label = this.previousElementSibling;
      if (label && label.tagName === 'LABEL') {
        label.classList.add('text-primary', 'transform', '-translate-y-1');
      }
    });

    input.addEventListener('blur', function() {
      const parent = this.closest('.relative') || this.parentElement;
      parent.classList.remove('ring-2', 'ring-primary/30', 'transform', 'scale-[1.02]');
      parent.classList.add('scale-100');

      // Remove floating label effect if field is empty
      const label = this.previousElementSibling;
      if (label && label.tagName === 'LABEL' && !this.value) {
        label.classList.remove('text-primary', 'transform', '-translate-y-1');
      }
    });

    // Add validation styling on input
    input.addEventListener('input', function() {
      const parent = this.closest('.relative') || this.parentElement;

      // Remove error styling if field has content
      if (this.value && parent.classList.contains('border-red-500')) {
        parent.classList.remove('border-red-500');
        parent.classList.add('border-green-500');
      }
    });
  });

  // Add subtle success animation on form submission
  form.addEventListener('submit', function(e) {
    // Don't prevent default - let the form submit normally
    // But add visual feedback
    const submitBtn = document.getElementById('signup-btn');
    if (submitBtn) {
      submitBtn.classList.add('animate-pulse');
      setTimeout(() => {
        submitBtn.classList.remove('animate-pulse');
      }, 1000);
    }
  });
});

// Password visibility toggle function
function togglePasswordVisibility(inputId) {
  const passwordInput = document.getElementById(inputId);
  const toggleButton = passwordInput.closest('.relative').querySelector('button');
  const toggleIcon = toggleButton.querySelector('.material-symbols-outlined');

  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.textContent = 'visibility';
  } else {
    passwordInput.type = 'password';
    toggleIcon.textContent = 'visibility_off';
  }
}

// Prevent password field from being auto-filled with email-like content
document.addEventListener('DOMContentLoaded', function() {
  const passwordInput = document.getElementById('password');
  const emailInput = document.getElementById('email');

  if (passwordInput && emailInput) {
    // Monitor for autofill issues
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
          const value = passwordInput.value;
          // If password field contains @ symbol, it might be getting email value
          if (value && value.includes('@') && value.includes('.')) {
            console.warn('Password field appears to have email value, clearing it');
            passwordInput.value = '';
          }
        }
      });
    });

    observer.observe(passwordInput, {
      attributes: true,
      attributeFilter: ['value']
    });

    // Also check on input events
    passwordInput.addEventListener('input', function() {
      const value = this.value;
      if (value && value.includes('@') && value.includes('.')) {
        console.warn('Password field has email-like value');
        this.value = '';
      }
    });
  }
});
</script>
{% endblock %}