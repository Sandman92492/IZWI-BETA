{% extends 'base.html' %}

{% block title %}iZwi - Post Verified Alert{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
.verified-alert-form {
  max-width: 600px;
  margin: 0 auto;
}
.category-btn {
  transition: all 0.2s ease;
}
.category-btn:hover {
  transform: translateY(-1px);
}
.category-btn.selected {
  ring-2 ring-offset-2;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3 min-w-0 flex-1">
          <a href="/super-admin{% if selected %}?community_id={{ selected.id }}{% endif %}" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex-shrink-0">
            <span class="material-symbols-outlined text-gray-600 dark:text-gray-300">arrow_back</span>
          </a>
          <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
            <span class="material-symbols-outlined text-emerald-600 text-lg sm:text-2xl flex-shrink-0">verified</span>
            <div class="min-w-0 flex-1">
              <h1 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white truncate">Post Verified Alert</h1>
              <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 truncate">Community: {{ selected.name if selected else 'Not selected' }}</p>
            </div>
          </div>
        </div>
        {% if selected %}
        <div class="hidden sm:flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 flex-shrink-0">
          <span class="material-symbols-outlined text-emerald-600">location_city</span>
          <span class="truncate max-w-24">{{ selected.name }}</span>
        </div>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <form method="POST" action="{{ url_for('super_admin_post_verified') }}" class="verified-alert-form bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-4 sm:p-8 w-full">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      {% if selected %}
      <input type="hidden" name="community_id" value="{{ selected.id }}"/>
      {% endif %}

      <!-- Category Selection -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-emerald-600">category</span>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Alert Category</h2>
        </div>
        <input type="hidden" name="category" id="selected_category" required>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <button type="button" onclick="selectCategory(event, 'Emergency')" class="category-btn flex flex-col sm:flex-row items-center gap-2 sm:gap-3 p-3 sm:p-4 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 text-center sm:text-left">
            <span class="text-xl sm:text-2xl">üö®</span>
            <span class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base">Emergency</span>
          </button>
          <button type="button" onclick="selectCategory(event, 'Fire')" class="category-btn flex flex-col sm:flex-row items-center gap-2 sm:gap-3 p-3 sm:p-4 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 text-center sm:text-left">
            <span class="text-xl sm:text-2xl">üî•</span>
            <span class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base">Fire</span>
          </button>
          <button type="button" onclick="selectCategory(event, 'Traffic')" class="category-btn flex flex-col sm:flex-row items-center gap-2 sm:gap-3 p-3 sm:p-4 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center sm:text-left">
            <span class="text-xl sm:text-2xl">üöó</span>
            <span class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base">Traffic</span>
          </button>
          <button type="button" onclick="selectCategory(event, 'Weather')" class="category-btn flex flex-col sm:flex-row items-center gap-2 sm:gap-3 p-3 sm:p-4 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 text-center sm:text-left">
            <span class="text-xl sm:text-2xl">‚õàÔ∏è</span>
            <span class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base">Weather</span>
          </button>
          <button type="button" onclick="selectCategory(event, 'Community')" class="category-btn flex flex-col sm:flex-row items-center gap-2 sm:gap-3 p-3 sm:p-4 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 text-center sm:text-left">
            <span class="text-xl sm:text-2xl">üèòÔ∏è</span>
            <span class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base">Community</span>
          </button>
          <button type="button" onclick="selectCategory(event, 'Other')" class="category-btn flex flex-col sm:flex-row items-center gap-2 sm:gap-3 p-3 sm:p-4 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 text-center sm:text-left">
            <span class="text-xl sm:text-2xl">‚ùó</span>
            <span class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base">Other</span>
          </button>
        </div>
      </div>

      <!-- Description -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-emerald-600">description</span>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Alert Description</h2>
        </div>
        <textarea name="description" id="description" class="w-full h-32 p-4 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:outline-none resize-none" placeholder="Provide detailed information about this verified alert..." required></textarea>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This alert will be marked as verified and posted immediately to the community.</p>
      </div>

      <!-- Alert Duration -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-emerald-600">schedule</span>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Alert Duration (Optional)</h2>
        </div>
        <select name="duration_minutes" id="duration_minutes" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:outline-none">
          <option value="">No expiration (permanent alert)</option>
          <option value="15">15 minutes</option>
          <option value="30">30 minutes</option>
          <option value="60">1 hour</option>
          <option value="120">2 hours</option>
          <option value="240">4 hours</option>
          <option value="480">8 hours</option>
          <option value="1440">24 hours</option>
        </select>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Set how long this verified alert should remain visible. Leave blank for permanent alerts.</p>
      </div>

      <!-- Location -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-emerald-600">location_on</span>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Location</h2>
        </div>
        <div class="mb-4 flex gap-3">
          <button type="button" onclick="requestCurrentLocation()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium">
            <span class="text-sm">üìç</span>
            <span>Use Current Location</span>
          </button>
          <div id="location-status" class="flex items-center gap-2 text-sm"></div>
        </div>
        <div class="relative h-48 sm:h-64 w-full rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
          <div id="location-map" class="w-full h-full"></div>
          <div class="absolute top-2 left-2 sm:top-3 sm:left-3 bg-white/90 dark:bg-gray-800/90 p-2 rounded-lg shadow-lg text-xs">
            <span class="text-gray-800 dark:text-gray-200">Click "Use Current Location" or click on the map to set location</span>
          </div>
        </div>
        <input type="hidden" name="latitude" id="latitude" required>
        <input type="hidden" name="longitude" id="longitude" required>
      </div>

      <!-- Address (Optional) -->
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-outlined text-emerald-600">edit_location</span>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Address (Optional)</h2>
        </div>
        <input type="text" name="address" id="address" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 focus:outline-none" placeholder="Enter a specific address or location description (optional)">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Provide a human-readable address or location description to help others find this location.</p>
      </div>

      <!-- Submit Button -->
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-8">
        <a href="/super-admin{% if selected %}?community_id={{ selected.id }}{% endif %}" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-3 px-6 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-center">
          Cancel
        </a>
        <button type="submit" id="post-alert-btn" class="flex-1 bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="btn-text">Post Verified Alert</span>
          <span class="btn-loading hidden">Posting...</span>
        </button>
      </div>
    </form>
  </main>
</div>

<script>
// Initialize location map
var locationMap = L.map('location-map').setView([-26.2041, 28.0473], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(locationMap);

var selectedMarker = null;

// Handle map clicks for location selection
locationMap.on('click', function(e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;

    // Remove existing marker
    if (selectedMarker) {
        locationMap.removeLayer(selectedMarker);
    }

    // Add new marker
    selectedMarker = L.marker([lat, lng]).addTo(locationMap);

    // Update form fields
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;

    showLocationStatus('Location set successfully', 'success');
});

// Location detection functions
function requestCurrentLocation() {
    if (!navigator.geolocation) {
        showLocationStatus('Location services not supported by your browser', 'error');
        return;
    }

    showLocationStatus('Getting your location...', 'loading');

    navigator.geolocation.getCurrentPosition(
        function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;

            // Update map view
            locationMap.setView([lat, lng], 15);

            // Remove existing marker
            if (selectedMarker) {
                locationMap.removeLayer(selectedMarker);
            }

            // Add marker at current location
            selectedMarker = L.marker([lat, lng]).addTo(locationMap);
            selectedMarker.bindPopup('<div class="text-center p-2"><strong>Your Current Location</strong></div>');

            // Update form fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            showLocationStatus('Location set successfully', 'success');
        },
        function(error) {
            var message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please manually click on the map to set location.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location unavailable. Please manually click on the map to set location.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out. Please try again or manually click on the map.';
                    break;
                default:
                    message = 'Error getting location. Please manually click on the map to set location.';
                    break;
            }
            showLocationStatus(message, 'error');
            console.log('Geolocation error:', error);
        },
        {
            timeout: 10000, // 10 second timeout
            enableHighAccuracy: true,
            maximumAge: 300000 // 5 minutes cache
        }
    );
}

function showLocationStatus(message, type) {
    const statusDiv = document.getElementById('location-status');

    let icon = '';
    let className = '';

    switch(type) {
        case 'loading':
            icon = '<div class="animate-spin w-4 h-4 border-2 border-emerald-600 border-t-transparent rounded-full"></div>';
            className = 'text-emerald-600';
            break;
        case 'success':
            icon = '‚úÖ';
            className = 'text-green-600';
            break;
        case 'error':
            icon = '‚ö†Ô∏è';
            className = 'text-yellow-600';
            break;
        default:
            icon = '‚ÑπÔ∏è';
            className = 'text-gray-600';
    }

    statusDiv.innerHTML = `<span>${icon}</span><span class="${className}">${message}</span>`;

    // Auto-hide success/error messages after 5 seconds
    if (type === 'success' || type === 'error') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 5000);
    }
}

// Category selection
function selectCategory(event, category) {
    // Get category colors
    const colors = {
        'Emergency': '#DC2626',
        'Fire': '#EA580C',
        'Traffic': '#2563EB',
        'Weather': '#7C3AED',
        'Community': '#059669',
        'Other': '#6B7280'
    };

    // Remove previous selection
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.style.backgroundColor = '';
        btn.style.borderColor = '';
        btn.style.color = '';
    });

    // Highlight selected category
    const selectedBtn = event.target.closest('.category-btn');
    selectedBtn.classList.add('selected');
    selectedBtn.style.backgroundColor = colors[category];
    selectedBtn.style.borderColor = colors[category];
    selectedBtn.style.color = 'white';

    // Update form field
    document.getElementById('selected_category').value = category;
}

// Form validation and submission with auto-location detection
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('post-alert-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    // Auto-detect location on page load (after a short delay to ensure map is ready)
    setTimeout(() => {
        requestCurrentLocation();
    }, 1000);

    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent normal form submission

        // Check if category is selected
        const selectedCategory = document.getElementById('selected_category').value;
        if (!selectedCategory) {
            alert('Please select a category for your alert.');
            return;
        }

        // Check if description is provided
        const description = document.getElementById('description').value.trim();
        if (!description) {
            alert('Please provide a description for your alert.');
            document.getElementById('description').focus();
            return;
        }

        // Check if location is set
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;

        if (!latitude || !longitude || (latitude === '0' && longitude === '0')) {
            alert('Please set your location by clicking "Use Current Location" or clicking on the map.');
            showLocationStatus('Location required - please click "Use Current Location" or click on the map', 'error');
            return;
        }

        // Submit via AJAX
        submitForm();
    });

    function submitForm() {
        // Disable button and show loading state
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');

        // Get form data
        const formData = new FormData(form);
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;

        // Submit the form
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success - redirect back to super admin dashboard
                const communityId = formData.get('community_id');
                const redirectUrl = communityId ?
                    `/super-admin?community_id=${communityId}` :
                    '/super-admin';

                // Show success message and redirect
                window.location.href = redirectUrl + '&alert_posted=1';
            } else {
                throw new Error(data.error || 'Failed to post alert');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to post alert: ' + error.message);

            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            btnText.classList.remove('hidden');
            btnLoading.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}
