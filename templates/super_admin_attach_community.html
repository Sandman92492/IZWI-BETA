<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>iZwi - Attach Community to Business</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2A9D8F",
              "background-light": "#F8F9FA",
              "background-dark": "#1A202C",
              "content-light": "#111827",
              "content-dark": "#F8F9FA",
              "subtle-light": "#E5E7EB",
              "subtle-dark": "#4A5568",
              "placeholder-light": "#9CA3AF",
              "placeholder-dark": "#718096",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              full: "9999px",
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-content-light dark:text-content-dark">
<div id="flash-container" class="fixed top-4 inset-x-0 z-50 flex justify-center px-4">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="space-y-3 max-w-md w-full animate-fade-in">
      {% for category, message in messages %}
        <div class="alert-message flex items-start gap-3 p-4 rounded-lg shadow-lg {% if category == 'success' %}bg-green-50 text-green-800 dark:bg-green-900/20 dark:text-green-200{% elif category == 'error' %}bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200{% else %}bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200{% endif %} border-l-4 {% if category == 'success' %}border-green-500{% elif category == 'error' %}border-red-500{% else %}border-yellow-500{% endif %}" role="alert">
          <span class="material-symbols-outlined mt-0.5 {% if category == 'success' %}text-green-600{% elif category == 'error' %}text-red-600{% else %}text-yellow-600{% endif %}">{% if category == 'success' %}check_circle{% elif category == 'error' %}error{% else %}warning{% endif %}</span>
          <span class="text-base font-normal">{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
</div>

<!-- Header -->
<div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('super_admin_dashboard') }}" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          <span class="text-sm">Back to Dashboard</span>
        </a>
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('logout') }}" class="text-sm px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          Switch Account
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="max-w-7xl mx-auto p-4">
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-2">
      <span class="material-symbols-outlined text-primary text-2xl">link</span>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Attach Existing Community</h1>
    </div>
    <p class="text-gray-600 dark:text-gray-300">
      Attach an existing unattached community to your business. This will give the community premium features and allow you to manage it from your dashboard.
    </p>
  </div>

  {% if communities %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          Available Communities ({{ communities|length }})
        </h2>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-gray-700/50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Community
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Admin
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Members
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Created
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            {% for community in communities %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">
                      <span class="material-symbols-outlined text-primary text-lg">location_city</span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                      {{ community.name }}
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                      ID: {{ community.id }}
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 dark:text-white">
                  {% if community.admin_user_id %}
                    {{ community.admin_user.name if community.admin_user else 'Unknown Admin' }}
                  {% else %}
                    <span class="text-gray-500">No admin assigned</span>
                  {% endif %}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 dark:text-white">
                  {{ community.member_count or 0 }} members
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 dark:text-white">
                  {{ community.created_at.strftime('%Y-%m-%d') if community.created_at else 'Unknown' }}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="attachCommunity({{ community.id }}, '{{ community.name }}')"
                        class="inline-flex items-center gap-2 px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm font-medium">
                  <span class="material-symbols-outlined text-sm">link</span>
                  Attach
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center">
      <div class="flex flex-col items-center">
        <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
          <span class="material-symbols-outlined text-gray-400 text-2xl">location_city</span>
        </div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No unattached communities found</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-md">
          All communities are already attached to businesses, or there are no communities available for attachment.
        </p>
        <a href="{{ url_for('super_admin_dashboard') }}"
           class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          Back to Dashboard
        </a>
      </div>
    </div>
  {% endif %}
</div>

<!-- Confirmation Modal -->
<div id="attach-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center" style="z-index: 2147483647;">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Confirm Attachment</h3>
        <button id="close-attach-modal" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>
    <div class="p-6">
      <div class="flex items-start gap-3 mb-4">
        <div class="flex-shrink-0 w-10 h-10 bg-yellow-100 dark:bg-yellow-900/20 rounded-full flex items-center justify-center">
          <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400">warning</span>
        </div>
        <div class="flex-1">
          <h4 class="font-medium text-gray-900 dark:text-white mb-1">Attach Community</h4>
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Are you sure you want to attach <strong id="community-name-text"></strong> to your business?
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
            This action will give the community premium features and allow you to manage it from your dashboard.
          </p>
        </div>
      </div>

      <div class="flex gap-3 justify-end">
        <button id="cancel-attach" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
          Cancel
        </button>
        <form id="attach-form" method="POST" class="inline">
          <input type="hidden" name="community_id" id="attach-community-id">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
            Attach Community
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Modal management
function attachCommunity(communityId, communityName) {
    document.getElementById('community-name-text').textContent = communityName;
    document.getElementById('attach-community-id').value = communityId;
    document.getElementById('attach-modal').classList.remove('hidden');
}

document.getElementById('close-attach-modal').addEventListener('click', function() {
    document.getElementById('attach-modal').classList.add('hidden');
});

document.getElementById('cancel-attach').addEventListener('click', function() {
    document.getElementById('attach-modal').classList.add('hidden');
});

// Close modal when clicking outside
document.getElementById('attach-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.add('hidden');
    }
});

// Auto-hide flash messages after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alertMessages = document.querySelectorAll('.alert-message');
    const flashContainer = document.getElementById('flash-container');

    alertMessages.forEach(function(message) {
        setTimeout(function() {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
                if (flashContainer && !flashContainer.querySelector('.alert-message')) {
                    flashContainer.remove();
                }
            }, 500);
        }, 5000);
    });
});

// Show loading state for attach form
document.getElementById('attach-form').addEventListener('submit', function() {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    submitBtn.textContent = 'Attaching...';

    // Re-enable after a delay (in case of error)
    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        submitBtn.textContent = originalText;
    }, 10000);
});
</script>

</body></html>
