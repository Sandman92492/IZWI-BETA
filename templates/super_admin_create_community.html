<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>iZwi - Create Business Community</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2A9D8F",
              "background-light": "#F8F9FA",
              "background-dark": "#1A202C",
              "content-light": "#111827",
              "content-dark": "#F8F9FA",
              "subtle-light": "#E5E7EB",
              "subtle-dark": "#4A5568",
              "placeholder-light": "#9CA3AF",
              "placeholder-dark": "#718096",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              full: "9999px",
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
      }

      .step-indicator {
        transition: all 0.3s ease;
      }

      .step-active {
        background-color: #2A9D8F !important;
        color: white !important;
      }
    </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-content-light dark:text-content-dark">
<div id="flash-container" class="fixed top-4 inset-x-0 z-50 flex justify-center px-4">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="space-y-3 max-w-md w-full animate-fade-in">
      {% for category, message in messages %}
        <div class="alert-message flex items-start gap-3 p-4 rounded-lg shadow-lg {% if category == 'success' %}bg-green-50 text-green-800 dark:bg-green-900/20 dark:text-green-200{% elif category == 'error' %}bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200{% else %}bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200{% endif %} border-l-4 {% if category == 'success' %}border-green-500{% elif category == 'error' %}border-red-500{% else %}border-yellow-500{% endif %}" role="alert">
          <span class="material-symbols-outlined mt-0.5 {% if category == 'success' %}text-green-600{% elif category == 'error' %}text-red-600{% else %}text-yellow-600{% endif %}">{% if category == 'success' %}check_circle{% elif category == 'error' %}error{% else %}warning{% endif %}</span>
          <span class="text-base font-normal">{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
</div>

<!-- Progress Header -->
<div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
  <div class="max-w-4xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('super_admin_dashboard') }}" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          <span class="text-sm">Back to Dashboard</span>
        </a>
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('logout') }}" class="text-sm px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          Switch Account
        </a>
      </div>
    </div>

    <!-- Progress Steps -->
    <div class="flex items-center justify-center space-x-4">
      <div class="flex items-center">
        <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold step-indicator step-active">1</div>
        <span class="ml-2 text-sm font-medium text-gray-900 dark:text-white">Name</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold step-indicator">2</div>
        <span class="ml-2 text-sm font-medium text-gray-500">Location</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold step-indicator">3</div>
        <span class="ml-2 text-sm font-medium text-gray-500">Create</span>
      </div>
    </div>
  </div>
</div>

<div class="flex flex-col lg:flex-row min-h-screen">
  <!-- Instructions Panel - Mobile & Desktop -->
  <div class="w-full lg:w-80 bg-white dark:bg-gray-800 border-b lg:border-b-0 lg:border-r border-gray-200 dark:border-gray-700 p-4 lg:p-6 order-1 lg:order-1">
    <div class="lg:sticky lg:top-6">
      <!-- Mobile/Tablet Instructions -->
      <div class="lg:hidden mb-4">
        <div class="bg-primary/10 rounded-lg p-4 mb-4">
          <div class="flex items-center mb-2">
            <span class="material-symbols-outlined text-primary mr-2">info</span>
            <h3 class="font-medium text-gray-900 dark:text-white">How to Create Your Community</h3>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-300 space-y-2">
            <p><strong>Step 1:</strong> Enter your community name</p>
            <p><strong>Step 2:</strong> Draw a boundary on the map to define your area</p>
            <p><strong>Step 3:</strong> Create your community!</p>
          </div>
        </div>
      </div>

      <!-- Desktop Instructions -->
      <div class="hidden lg:block">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Community Setup Guide</h2>

        <!-- Step 1 -->
        <div class="mb-6 p-4 bg-primary/10 rounded-lg">
          <div class="flex items-center mb-2">
            <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs font-semibold mr-2">1</span>
            <h3 class="font-medium text-gray-900 dark:text-white">Name Your Community</h3>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Give your community a clear, recognizable name that reflects your neighborhood or area.
          </p>
        </div>

        <!-- Step 2 -->
        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
          <div class="flex items-center mb-2">
            <span class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs font-semibold mr-2">2</span>
            <h3 class="font-medium text-gray-900 dark:text-white">Define Location</h3>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Draw a boundary around your community area on the map. This helps focus alerts to your local area.
          </p>
        </div>

        <!-- Tips -->
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
          <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center">
            <span class="material-symbols-outlined text-blue-500 mr-2 text-sm">lightbulb</span>
            Pro Tips
          </h4>
          <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
            <li>• Include major streets or landmarks</li>
            <li>• Start with a rough outline and refine</li>
            <li>• You can always adjust boundaries later</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col order-2 lg:order-2">
    <!-- Step 1: Community Name -->
    <div id="step-1" class="flex-1 p-6">
      <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Create a new business community</h1>
          <p class="text-gray-600 dark:text-gray-300">This community will be attached to your business and receive premium features</p>
        </div>

        <form method="POST" class="space-y-6">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="community-name">
              Community Name *
            </label>
            <input class="w-full h-12 px-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-transparent" id="community-name" name="community_name" placeholder="e.g., Downtown Community, Riverdale Neighborhood" type="text" required/>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This name will be visible to all community members</p>
          </div>

          <input type="hidden" name="boundary_data" id="boundary_data">

          <!-- Navigation Buttons -->
          <div class="flex justify-between pt-4">
            <button type="button" onclick="window.history.back()" class="px-6 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              Back
            </button>
            <button type="button" onclick="nextStep()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
              Continue to Location
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Step 2: Map Interface -->
    <div id="step-2" class="flex-1 hidden">
      <div class="h-full flex flex-col">
        <!-- Map Controls -->
        <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
          <div class="flex flex-wrap gap-3 items-center justify-between">
            <div class="flex gap-3">
              <input id="addressSearchDefine" type="text" placeholder="Search for address or landmark..."
                     class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary focus:border-primary text-sm flex-1 min-w-48">
              <button type="button" onclick="searchAddressDefine()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm font-medium">
                Search
              </button>
            </div>
            <button type="button" onclick="useMyLocationDefine()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
              <span class="material-symbols-outlined text-sm">my_location</span>
              Use My Location
            </button>
          </div>
        </div>

        <!-- Map Container -->
        <div class="flex-1 relative">
          <div id="community-map" class="w-full h-full min-h-[400px] sm:min-h-[500px]"></div>

          <!-- Map Instructions - Enhanced for Mobile -->
          <div class="absolute top-4 left-4 right-4 lg:left-4 lg:right-auto bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg p-3 sm:p-4 shadow-lg">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mt-0.5">
                <span class="material-symbols-outlined text-primary text-lg">edit</span>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base mb-1">Draw Your Community Boundary</h3>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
                  <strong>How:</strong> Tap on the map to add points around your community area. Double-tap to finish.
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  💡 <strong>Tip:</strong> Include streets, parks, or landmarks to define your area clearly.
                </p>
              </div>
            </div>
          </div>

          <!-- Drawing Status & CTA -->
          <div class="absolute bottom-4 left-4 right-4 lg:left-4 lg:right-auto" id="drawing-status-container">
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg p-3 sm:p-4 shadow-lg">
              <div class="flex items-start gap-3" id="status-content">
                <div class="flex-shrink-0 w-6 h-6 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                  <span class="material-symbols-outlined text-gray-500 text-sm">info</span>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-600 dark:text-gray-300" id="status-message">
                    Ready to draw! Click the polygon tool on the map to start defining your community boundary.
                  </p>
                </div>
              </div>

              <!-- Prominent CTA Button for Mobile -->
              <div class="mt-3 lg:hidden" id="mobile-cta">
                <button type="button" onclick="startDrawingMode()"
                        class="w-full bg-primary text-white font-semibold py-3 px-4 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">edit</span>
                  Start Drawing Boundary
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step Navigation -->
        <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
          <div class="flex justify-between items-center">
            <button type="button" onclick="prevStep()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              Back to Name
            </button>
            <div class="flex gap-3">
              <button type="button" onclick="skipBoundary()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
                Skip for now
              </button>
              <button type="button" onclick="nextStep()" id="continue-btn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Create Community
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Step management
let currentStep = 1;
let communityMap = null;
let drawnItems = null;
let hasBoundary = false;

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    setupEventListeners();
    updateStepIndicator();

    // Auto-hide flash messages after 5 seconds
    const alertMessages = document.querySelectorAll('.alert-message');
    const flashContainer = document.getElementById('flash-container');
    alertMessages.forEach(function(message) {
        setTimeout(function() {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
                if (flashContainer && !flashContainer.querySelector('.alert-message')) {
                    flashContainer.remove();
                }
            }, 500);
        }, 5000);
    });
});

// Initialize the map
function initializeMap() {
    // Initialize the community boundary map
    communityMap = L.map('community-map', {
        gestureHandling: true,
        zoomControl: true,
        scrollWheelZoom: true
    }).setView([-26.2041, 28.0473], 13);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(communityMap);

    // Initialize the FeatureGroup to store editable layers
    drawnItems = new L.FeatureGroup();
    communityMap.addLayer(drawnItems);

    // Initialize the draw control
    var drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems
        },
        draw: {
            polygon: {
                allowIntersection: false,
                drawError: {
                    color: '#e1e100',
                    message: '<strong>Error:</strong> shape edges cannot cross!'
                },
                shapeOptions: {
                    color: '#2A9D8F',
                    fillOpacity: 0.2,
                    weight: 2
                }
            },
            polyline: false,
            rectangle: false,
            circle: false,
            marker: false,
            circlemarker: false
        }
    });
    communityMap.addControl(drawControl);

    // Handle drawing events
    communityMap.on(L.Draw.Event.CREATED, function (e) {
        var type = e.layerType,
            layer = e.layer;

        // Clear existing drawings (only allow one boundary)
        drawnItems.clearLayers();

        // Add the new boundary
        drawnItems.addLayer(layer);

        // Store boundary data
        var boundaryData = layer.toGeoJSON();
        document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
        hasBoundary = true;
        updateContinueButton();

        // Update status
        updateDrawingStatus('Perfect! Community boundary defined. You can edit it using the map tools or continue to create your community.');
    });

    communityMap.on(L.Draw.Event.EDITED, function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            var boundaryData = layer.toGeoJSON();
            document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
            hasBoundary = true;
            updateContinueButton();
        });
    });

    communityMap.on(L.Draw.Event.DELETED, function (e) {
        document.getElementById('boundary_data').value = '';
        hasBoundary = false;
        updateContinueButton();
        updateDrawingStatus('Ready to draw! Click the polygon tool on the map to start defining your community boundary.');
    });

    // Get user's current location for initial map center
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                communityMap.setView([lat, lng], 15);

                // Add a marker to show user's location
                L.marker([lat, lng]).addTo(communityMap)
                    .bindPopup('Your current location')
                    .openPopup();
            },
            function(error) {
                console.log('Geolocation error:', error);
                // Stay with default coordinates if geolocation fails
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
    }
}

// Step navigation functions
function nextStep() {
    if (currentStep === 1) {
        // Validate community name
        const communityName = document.getElementById('community-name').value.trim();
        if (!communityName) {
            showAlert('Please enter a community name', 'error');
            return;
        }

        // Move to step 2
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        currentStep = 2;
        updateStepIndicator();

        // Focus map after transition
        setTimeout(() => {
            communityMap.invalidateSize();
        }, 100);
    } else if (currentStep === 2) {
        // Create community
        createCommunity();
    }
}

function prevStep() {
    if (currentStep === 2) {
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-1').classList.remove('hidden');
        currentStep = 1;
        updateStepIndicator();
    }
}

function updateStepIndicator() {
    // Update step indicators
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        if (index + 1 === currentStep) {
            indicator.classList.add('step-active');
            indicator.classList.remove('bg-gray-200', 'text-gray-500');
            indicator.classList.add('bg-primary', 'text-white');
        } else {
            indicator.classList.remove('step-active');
            indicator.classList.add('bg-gray-200', 'text-gray-500');
            indicator.classList.remove('bg-primary', 'text-white');
        }
    });

    // Update step labels
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const label = indicator.nextElementSibling;
        if (index + 1 === currentStep) {
            label.classList.remove('text-gray-500');
            label.classList.add('text-gray-900', 'dark:text-white');
        } else {
            label.classList.add('text-gray-500');
            label.classList.remove('text-gray-900', 'dark:text-white');
        }
    });
}

function updateContinueButton() {
    const continueBtn = document.getElementById('continue-btn');
    if (hasBoundary) {
        continueBtn.disabled = false;
        continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        continueBtn.disabled = true;
        continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function updateDrawingStatus(message) {
    const statusEl = document.getElementById('status-message');
    const statusContent = document.getElementById('status-content');
    const mobileCta = document.getElementById('mobile-cta');

    if (statusEl) {
        statusEl.textContent = message;
    }

    // Show/hide mobile CTA based on whether boundary exists
    if (mobileCta) {
        if (hasBoundary) {
            mobileCta.style.display = 'none';
            if (statusContent) {
                statusContent.classList.remove('pb-3');
            }
        } else {
            mobileCta.style.display = 'block';
            if (statusContent) {
                statusContent.classList.add('pb-3');
            }
        }
    }
}

function startDrawingMode() {
    // Trigger the draw control programmatically
    const drawControl = document.querySelector('.leaflet-draw-draw-polygon');
    if (drawControl) {
        drawControl.click();
        updateDrawingStatus('Great! Now tap on the map to add points for your community boundary.');
    } else {
        updateDrawingStatus('Draw tool not available. Please use the polygon tool from the map toolbar.');
    }
}

function skipBoundary() {
    // Set empty boundary and continue
    document.getElementById('boundary_data').value = '';
    hasBoundary = true;
    updateContinueButton();
    createCommunity();
}

function createCommunity() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('continue-btn');
    const originalText = submitBtn.textContent;

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    submitBtn.textContent = 'Creating Community...';

    // Submit form
    form.submit();
}

// Map helper functions
function useMyLocationDefine() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                communityMap.setView([lat, lng], 16);

                // Remove any existing location markers
                communityMap.eachLayer(function(layer) {
                    if (layer instanceof L.Marker && layer.getPopup() &&
                        layer.getPopup().getContent() === 'Your current location') {
                        communityMap.removeLayer(layer);
                    }
                });

                // Add new location marker
                L.marker([lat, lng]).addTo(communityMap)
                    .bindPopup('Your current location')
                    .openPopup();
            },
            function(error) {
                showAlert('Unable to get your location. Please check your browser permissions.', 'error');
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    } else {
        showAlert('Geolocation is not supported by your browser.', 'error');
    }
}

function searchAddressDefine() {
    const query = document.getElementById('addressSearchDefine').value.trim();
    if (!query) {
        showAlert('Please enter an address or location to search for.', 'warning');
        return;
    }

    // Use OpenStreetMap Nominatim for geocoding (free, no API key needed)
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=za`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);

                communityMap.setView([lat, lng], 15);

                // Add a marker for the searched location
                L.marker([lat, lng]).addTo(communityMap)
                    .bindPopup(`Found: ${result.display_name}`)
                    .openPopup();

                // Clear the search box
                document.getElementById('addressSearchDefine').value = '';
            } else {
                showAlert('Location not found. Please try a different search term.', 'warning');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showAlert('Error searching for location. Please try again.', 'error');
        });
}

// Utility functions
function showAlert(message, type = 'info') {
    const flashContainer = document.getElementById('flash-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert-message flex items-start gap-3 p-4 rounded-lg shadow-lg animate-fade-in ${
        type === 'error' ? 'bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200 border-l-4 border-red-500' :
        type === 'warning' ? 'bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200 border-l-4 border-yellow-500' :
        'bg-blue-50 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200 border-l-4 border-blue-500'
    }`;
    alertDiv.innerHTML = `
        <span class="material-symbols-outlined mt-0.5 ${
            type === 'error' ? 'text-red-600' :
            type === 'warning' ? 'text-yellow-600' :
            'text-blue-600'
        }">
            ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'}
        </span>
        <span class="text-base font-normal">${message}</span>
    `;

    if (flashContainer) {
        flashContainer.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.style.transition = 'opacity 0.5s ease-out';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
        }, 5000);
    }
}

// Event listeners
function setupEventListeners() {
    // Enter key to trigger search
    const addressInput = document.getElementById('addressSearchDefine');
    if (addressInput) {
        addressInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchAddressDefine();
            }
        });
    }

    // Community name validation
    const communityNameInput = document.getElementById('community-name');
    if (communityNameInput) {
        communityNameInput.addEventListener('input', function() {
            const name = this.value.trim();
            if (name.length > 0 && name.length <= 100) {
                this.classList.remove('border-red-500');
                this.classList.add('border-green-500');
            } else if (name.length > 100) {
                this.classList.remove('border-green-500');
                this.classList.add('border-red-500');
            } else {
                this.classList.remove('border-red-500', 'border-green-500');
            }
        });
    }
}
</script>

</body></html>