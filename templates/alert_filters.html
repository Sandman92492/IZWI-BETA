<!-- Enhanced Alert Filter Component -->
<div class="bg-white dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm mb-4">
  <!-- Filter Header -->
  <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3 flex-1">
        <button onclick="toggleFilters()" class="flex items-center gap-2 text-left flex-1 hover:bg-gray-50 dark:hover:bg-gray-800/50 p-2 -m-2 rounded-md transition-colors group">
          <span class="material-symbols-outlined text-primary group-hover:scale-110 transition-transform">filter_list</span>
          <h3 class="font-display font-semibold text-lg text-gray-900 dark:text-gray-100">
            Filter Alerts
          </h3>
          <!-- Active Filters Summary -->
          <div id="active-filters-summary" class="hidden items-center gap-2 ml-2">
            <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full font-medium" id="active-count">0</span>
            <span class="text-sm text-gray-600 dark:text-gray-400">filters active</span>
          </div>
        </button>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleFilters()" class="inline-flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-all duration-200 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-md">
          <span class="material-symbols-outlined text-base transition-transform duration-200" id="filter-toggle-icon">expand_more</span>
          <span id="filter-toggle-text" class="hidden sm:inline">Show Filters</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Controls (Initially Hidden) -->
  <div id="filter-controls" class="hidden">
    <div class="px-4 sm:px-6 py-4 max-h-[70vh] sm:max-h-none overflow-y-auto sm:overflow-visible">
      <!-- Filter Presets -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
          Quick Filters
        </label>
        <div class="flex flex-wrap gap-2" id="filter-presets">
          <button onclick="applyPresetFilter('today')" class="px-3 py-2 text-xs font-medium rounded-full border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            Today
          </button>
          <button onclick="applyPresetFilter('week')" class="px-3 py-2 text-xs font-medium rounded-full border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            This Week
          </button>
          <button onclick="applyPresetFilter('verified')" class="px-3 py-2 text-xs font-medium rounded-full border border-green-300 dark:border-green-600 text-green-700 dark:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
            <span class="material-symbols-outlined text-sm mr-1">verified</span>
            Verified Only
          </button>
          <button onclick="applyPresetFilter('emergency')" class="px-3 py-2 text-xs font-medium rounded-full border border-red-300 dark:border-red-600 text-red-700 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
            ðŸš¨ Emergency
          </button>
        </div>
      </div>

      <!-- Main Filter Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Category Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Category
          </label>
          <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">All Categories</option>
            <option value="Emergency">Emergency</option>
            <option value="Fire">Fire</option>
            <option value="Traffic">Traffic</option>
            <option value="Weather">Weather</option>
            <option value="Community">Community</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Status Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Status
          </label>
          <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>

        <!-- Verification Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Verification
          </label>
          <select id="verification-filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">All Alerts</option>
            <option value="verified">Verified Only</option>
            <option value="unverified">Unverified Only</option>
          </select>
        </div>

        <!-- Date Range Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Date Range
          </label>
          <select id="date-filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
      </div>

      <!-- Search and Filter Actions -->
      <div class="space-y-4">
        <!-- Search Input -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Search Alerts
          </label>
          <div class="relative">
            <input type="text" id="search-filter" placeholder="Search by description, location, or author..." class="w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg">search</span>
          </div>
        </div>

        <!-- Filter Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 justify-between">
          <div class="flex gap-2">
            <button onclick="applyFilters()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-200 flex items-center gap-2 font-medium">
              <span class="material-symbols-outlined text-sm">search</span>
              Apply Filters
            </button>
            <button onclick="clearFilters()" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 flex items-center gap-2 font-medium">
              <span class="material-symbols-outlined text-sm">clear_all</span>
              Clear All
            </button>
          </div>

          <!-- Results Count -->
          <div id="results-count" class="text-sm text-gray-600 dark:text-gray-400">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="filter-loading" class="hidden absolute inset-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-lg">
    <div class="flex items-center gap-3 text-primary">
      <div class="animate-spin w-5 h-5 border-2 border-primary border-t-transparent rounded-full"></div>
      <span class="font-medium">Filtering...</span>
    </div>
  </div>
</div>

<script>
// Enhanced Filter State Management
let filterState = {
  category: '',
  status: '',
  verification: '',
  date: '',
  search: ''
};

// Load saved filter state from localStorage
function loadSavedFilterState() {
  try {
    const saved = localStorage.getItem('alertFilters');
    if (saved) {
      const parsed = JSON.parse(saved);
      // Only restore if not empty
      if (Object.values(parsed).some(value => value !== '')) {
        filterState = { ...filterState, ...parsed };
        // Apply the saved filters
        Object.keys(filterState).forEach(key => {
          const element = document.getElementById(`${key}-filter`);
          if (element) element.value = filterState[key];
        });
        updateActiveFilterDisplay();
      }
    }
  } catch (e) {
    console.warn('Failed to load saved filter state:', e);
  }
}

// Save filter state to localStorage
function saveFilterState() {
  try {
    localStorage.setItem('alertFilters', JSON.stringify(filterState));
  } catch (e) {
    console.warn('Failed to save filter state:', e);
  }
}

// Update active filters display
function updateActiveFilterDisplay() {
  const activeCount = Object.values(filterState).filter(value => value !== '').length;
  const summary = document.getElementById('active-filters-summary');
  const countElement = document.getElementById('active-count');

  if (activeCount > 0) {
    countElement.textContent = activeCount;
    summary.classList.remove('hidden');
  } else {
    summary.classList.add('hidden');
  }
}

// Show loading state
function showFilterLoading() {
  const loading = document.getElementById('filter-loading');
  if (loading) loading.classList.remove('hidden');
}

// Hide loading state
function hideFilterLoading() {
  const loading = document.getElementById('filter-loading');
  if (loading) loading.classList.add('hidden');
}

// Update results count display
function updateResultsCount(count) {
  const resultsElement = document.getElementById('results-count');
  if (resultsElement) {
    if (count !== undefined) {
      resultsElement.textContent = `${count} alert${count !== 1 ? 's' : ''} found`;
      resultsElement.classList.remove('text-gray-600', 'dark:text-gray-400');
      resultsElement.classList.add('text-green-600', 'dark:text-green-400');
    } else {
      resultsElement.textContent = '';
    }
  }
}

// Toggle filter visibility with smooth animation
function toggleFilters() {
  const controls = document.getElementById('filter-controls');
  const icon = document.getElementById('filter-toggle-icon');
  const text = document.getElementById('filter-toggle-text');

  if (controls.classList.contains('hidden')) {
    controls.classList.remove('hidden');
    icon.textContent = 'expand_less';
    text.textContent = 'Hide Filters';
    icon.style.transform = 'rotate(180deg)';
  } else {
    controls.classList.add('hidden');
    icon.textContent = 'expand_more';
    text.textContent = 'Show Filters';
    icon.style.transform = 'rotate(0deg)';
  }
}

// Apply filter preset
function applyPresetFilter(preset) {
  // Clear all filters first
  clearFilters();

  switch (preset) {
    case 'today':
      document.getElementById('date-filter').value = 'today';
      filterState.date = 'today';
      break;
    case 'week':
      document.getElementById('date-filter').value = 'week';
      filterState.date = 'week';
      break;
    case 'verified':
      document.getElementById('verification-filter').value = 'verified';
      filterState.verification = 'verified';
      break;
    case 'emergency':
      document.getElementById('category-filter').value = 'Emergency';
      filterState.category = 'Emergency';
      break;
  }

  saveFilterState();
  updateActiveFilterDisplay();
  applyFilters();
}

// Enhanced apply filters with loading state
function applyFilters() {
  showFilterLoading();

  // Update filter state
  filterState.category = document.getElementById('category-filter').value;
  filterState.status = document.getElementById('status-filter').value;
  filterState.verification = document.getElementById('verification-filter').value;
  filterState.date = document.getElementById('date-filter').value;
  filterState.search = document.getElementById('search-filter').value;

  saveFilterState();
  updateActiveFilterDisplay();

  // Call the filtering function (to be implemented by parent page)
  if (typeof filterAlerts === 'function') {
    filterAlerts(filterState);
  } else if (typeof loadGuardAlerts === 'function') {
    // For guard dashboard, reload with filters
    loadGuardAlertsWithFilters(filterState);
  }

  // Don't auto-close the filter panel - let updateFilterResults handle it based on results
}

// Enhanced clear filters
function clearFilters() {
  document.getElementById('category-filter').value = '';
  document.getElementById('status-filter').value = '';
  document.getElementById('verification-filter').value = '';
  document.getElementById('date-filter').value = '';
  document.getElementById('search-filter').value = '';

  // Reset filter state
  filterState = {
    category: '',
    status: '',
    verification: '',
    date: '',
    search: ''
  };

  saveFilterState();
  updateActiveFilterDisplay();

  // Apply cleared filters
  if (typeof filterAlerts === 'function') {
    filterAlerts(filterState);
  } else if (typeof loadGuardAlerts === 'function') {
    // For guard dashboard, reload with cleared filters
    loadGuardAlertsWithFilters(filterState);
  }

  // Auto-close the filter panel after clearing filters
  setTimeout(() => {
    toggleFilters();
  }, 100); // Small delay to ensure clearing completes first
}

// Add real-time search
let searchTimeout;
function setupSearchFilter() {
  const searchInput = document.getElementById('search-filter');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        filterState.search = this.value;
        saveFilterState();
        updateActiveFilterDisplay();
        applyFilters();
      }, 300); // Debounce search
    });
  }
}

// Add filter change listeners
function setupFilterListeners() {
  const filters = ['category', 'status', 'verification', 'date'];
  filters.forEach(filterId => {
    const element = document.getElementById(`${filterId}-filter`);
    if (element) {
      element.addEventListener('change', function() {
        filterState[filterId] = this.value;
        saveFilterState();
        updateActiveFilterDisplay();
        applyFilters();
      });
    }
  });
}

// Initialize filters as collapsed by default on all screen sizes
document.addEventListener('DOMContentLoaded', function() {
  // Load saved state
  loadSavedFilterState();

  // Setup event listeners
  setupSearchFilter();
  setupFilterListeners();

  // Update active filter display
  updateActiveFilterDisplay();

  // Ensure controls are hidden by default
  const controls = document.getElementById('filter-controls');
  const icon = document.getElementById('filter-toggle-icon');
  if (controls && !controls.classList.contains('hidden')) {
    controls.classList.add('hidden');
    icon.textContent = 'expand_more';
  }
});

// Listen for filter results updates from parent
if (typeof window !== 'undefined') {
  window.updateFilterResults = function(count) {
    hideFilterLoading();
    updateResultsCount(count);
  };
}
</script>
