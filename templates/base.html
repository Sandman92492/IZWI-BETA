<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" name="viewport"/>
    <title>{% block title %}iZwi{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='styles/app.css') }}?v={{ config['ASSET_VERSION'] }}" rel="stylesheet"/>

    <!-- Push Notifications Script -->
    <script src="{{ url_for('static', filename='js/push-notifications.js') }}?v={{ config['ASSET_VERSION'] }}"></script>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#17a899">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="iZwi">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">

    <!-- CSRF Token for API calls -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <script>
        // Theme bootstrap: set initial theme before paint
        (function() {
            try {
                var stored = localStorage.getItem('theme');
                var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                var useDark = stored ? (stored === 'dark') : prefersDark;
                if (useDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            } catch (_) {}
        })();
    </script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#17a899",
                        "background-light": "#f7f9f9",
                        "background-dark": "#142522",
                        "success-light": "#e6f7f5",
                        "success-dark-text": "#19b3a1",
                        "error-light": "#fdeaea",
                        "error-dark-text": "#ef4444",
                        "info-light": "#e9f5fe",
                        "info-dark-text": "#3b82f6"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings:
        'FILL' 1,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
      }
    </style>
    <style>
    body {
      margin: 0;
      min-height: max(884px, 100dvh);
    }
  </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-background-light dark:bg-background-dark font-display" data-user-id="{{ current_user.id if current_user.is_authenticated else '' }}">
<div id="flash-container" class="fixed top-4 inset-x-0 z-50 flex justify-center px-4">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="space-y-3 max-w-md w-full">
      {% for category, message in messages %}
        <div class="alert-message flex items-center gap-4 p-4 rounded-xl shadow-lg {% if category == 'success' %}bg-success-light dark:bg-primary/20{% elif category == 'error' %}bg-error-light dark:bg-red-500/20{% else %}bg-info-light dark:bg-blue-500/20{% endif %}">
          <span class="material-symbols-outlined {% if category == 'success' %}text-success-dark-text dark:text-primary{% elif category == 'error' %}text-error-dark-text dark:text-red-400{% else %}text-info-dark-text dark:text-blue-400{% endif %}">{% if category == 'success' %}check_circle{% elif category == 'error' %}error{% else %}info{% endif %}</span>
          <p class="text-gray-800 dark:text-background-light font-medium">{{ message }}</p>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
</div>
{% if not current_user.is_authenticated or (not current_user.community_id and request.endpoint != 'super_admin_dashboard') %}
<!-- Mobile Navigation Bar -->
<div class="lg:hidden sticky top-0 z-40 bg-gradient-to-r from-white/95 via-white/90 to-white/95 dark:from-gray-900/95 dark:via-gray-900/90 dark:to-gray-900/95 backdrop-blur-lg border-b border-gray-200/50 dark:border-gray-700/50 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- Logo/Brand Section -->
      <div class="flex items-center gap-3">
        {% if current_user.is_authenticated %}
          {% if current_user.is_super_admin() and not session.get('current_community_id') %}
            <a href="{{ url_for('select_community') }}" class="group inline-flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200">
          {% else %}
            <a href="{{ url_for('dashboard') }}" class="group inline-flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200">
          {% endif %}
        {% else %}
          <a href="{{ url_for('index') }}" class="group inline-flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200">
        {% endif %}
          <div class="w-6 h-6 rounded bg-gradient-to-br from-primary to-primary/80 flex items-center justify-center shadow-sm group-hover:shadow-md transition-all duration-200">
            <span class="material-symbols-outlined text-white text-sm">home</span>
          </div>
          <span class="font-bold text-gray-900 dark:text-gray-100 tracking-tight">iZwi</span>
        </a>
      </div>

      <!-- Mobile Actions -->
      <div class="flex items-center gap-2">
        <!-- Mobile Hamburger Menu -->
        <button onclick="toggleMobileMenu()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800/50 transition-all duration-200 group" id="mobile-menu-button">
          <div class="w-5 h-5 flex flex-col justify-center items-center">
            <span class="bg-gray-700 dark:bg-gray-300 h-0.5 w-5 rounded-full transform transition-all duration-300 origin-center group-hover:bg-primary" id="hamburger-line-1"></span>
            <span class="bg-gray-700 dark:bg-gray-300 h-0.5 w-5 rounded-full transform transition-all duration-300 origin-center mt-0.5 group-hover:bg-primary" id="hamburger-line-2"></span>
            <span class="bg-gray-700 dark:bg-gray-300 h-0.5 w-5 rounded-full transform transition-all duration-300 origin-center mt-0.5 group-hover:bg-primary" id="hamburger-line-3"></span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Desktop Navigation Bar -->
<nav class="hidden lg:block sticky top-0 z-40 bg-gradient-to-r from-white/95 via-white/90 to-white/95 dark:from-gray-900/95 dark:via-gray-900/90 dark:to-gray-900/95 backdrop-blur-lg border-b border-gray-200/50 dark:border-gray-700/50 shadow-sm">
  <div class="max-w-7xl mx-auto px-6">
    <div class="h-16 flex items-center justify-between">
      <!-- Logo/Brand Section -->
      <div class="flex items-center gap-8">
        {% if current_user.is_authenticated %}
          {% if current_user.is_super_admin() and not session.get('current_community_id') %}
            <a href="{{ url_for('select_community') }}" class="group inline-flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200">
          {% else %}
            <a href="{{ url_for('dashboard') }}" class="group inline-flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200">
          {% endif %}
        {% else %}
          <a href="{{ url_for('index') }}" class="group inline-flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200">
        {% endif %}
          <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-primary/80 flex items-center justify-center shadow-sm group-hover:shadow-md transition-all duration-200">
            <span class="material-symbols-outlined text-white text-lg">home</span>
          </div>
          <span class="font-bold text-lg text-gray-900 dark:text-gray-100 tracking-tight">iZwi</span>
        </a>

        <!-- Navigation Links -->
        <div class="hidden xl:flex items-center gap-1">
          {% if current_user.is_authenticated %}
            {% if current_user.is_super_admin() and not session.get('current_community_id') %}
              <a href="{{ url_for('select_community') }}" class="nav-link px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-primary/5 dark:hover:bg-primary/10 transition-all duration-200 relative group">
            {% else %}
              <a href="{{ url_for('dashboard') }}" class="nav-link px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-primary/5 dark:hover:bg-primary/10 transition-all duration-200 relative group">
            {% endif %}
            <span class="relative z-10">Dashboard</span>
            <div class="absolute inset-0 rounded-lg bg-gradient-to-r from-primary/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
          </a>
          {% endif %}
          <a href="/post-alert" class="nav-link px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-primary/5 dark:hover:bg-primary/10 transition-all duration-200 relative group">
            <span class="relative z-10">Post Alert</span>
            <div class="absolute inset-0 rounded-lg bg-gradient-to-r from-primary/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
          </a>
          <a href="/alerts/history" class="nav-link px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-primary/5 dark:hover:bg-primary/10 transition-all duration-200 relative group">
            <span class="relative z-10">History</span>
            <div class="absolute inset-0 rounded-lg bg-gradient-to-r from-primary/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
          </a>
          {% if current_user.is_authenticated and current_user.business_id %}
          <a href="/super-admin" class="nav-link px-4 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-primary/5 dark:hover:bg-primary/10 transition-all duration-200 relative group">
            <span class="relative z-10">Super Admin</span>
            <div class="absolute inset-0 rounded-lg bg-gradient-to-r from-primary/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
          </a>
          {% endif %}
        </div>
      </div>

      <!-- User Actions -->
      <div class="flex items-center gap-2">
        <a href="/settings" class="group inline-flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary hover:bg-primary/5 dark:hover:bg-primary/10 transition-all duration-200">
          <span class="material-symbols-outlined text-lg">settings</span>
          <span class="hidden xl:inline">Settings</span>
        </a>
        <div class="w-px h-6 bg-gray-300 dark:bg-gray-600"></div>
        <a href="/logout" class="hidden lg:inline-flex group items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200">
          <span class="material-symbols-outlined text-lg">logout</span>
          <span class="hidden xl:inline">Logout</span>
        </a>
      </div>
    </div>
  </div>
  </nav>

  <!-- Mobile Navigation Menu (for all pages) -->
  <div id="mobile-menu" class="fixed inset-0 z-50 lg:hidden transform translate-x-full transition-transform duration-300 ease-in-out">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>

    <!-- Menu Panel -->
    <div class="absolute right-0 top-0 h-full w-80 max-w-[85vw] bg-white dark:bg-gray-800 shadow-2xl transform transition-transform duration-300 ease-in-out">
      <!-- Menu Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-primary/80 flex items-center justify-center shadow-sm">
            <span class="material-symbols-outlined text-white text-lg">menu</span>
          </div>
          <span class="font-bold text-lg text-gray-900 dark:text-gray-100">Menu</span>
        </div>
        <button onclick="toggleMobileMenu()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">close</span>
        </button>
      </div>

      <!-- Menu Items -->
      <div class="py-4">
        <!-- Main Navigation -->
        <div class="px-4 mb-6">
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Navigation</h3>
          <div class="space-y-1">
            {% if current_user.is_authenticated %}
              {% if current_user.is_super_admin() and not session.get('current_community_id') %}
                <a href="{{ url_for('select_community') }}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                  <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">home</span>
                  <span class="font-medium">Select Community</span>
                </a>
              {% else %}
                <a href="{{ url_for('dashboard') }}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                  <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">dashboard</span>
                  <span class="font-medium">Dashboard</span>
                </a>
              {% endif %}
            {% else %}
              <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">home</span>
                <span class="font-medium">Home</span>
              </a>
            {% endif %}


            <a href="/alerts/history" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
              <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">history</span>
              <span class="font-medium">Alert History</span>
            </a>

            {% if current_user.is_authenticated and current_user.business_id %}
            <a href="/super-admin" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
              <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">admin_panel_settings</span>
              <span class="font-medium">Super Admin</span>
            </a>
            {% endif %}
          </div>
        </div>

        <!-- Account Actions -->
        {% if current_user.is_authenticated %}
        <div class="px-4 mb-6">
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">Account</h3>
          <div class="space-y-1">
            <a href="{{ url_for('select_community') }}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
              <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">swap_horiz</span>
              <span class="font-medium">Switch Community</span>
            </a>

            <a href="{{ url_for('settings') }}" class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
              <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">settings</span>
              <span class="font-medium">Settings</span>
            </a>
          </div>
        </div>

        <!-- Logout -->
        <div class="px-4 pt-4 border-t border-gray-200 dark:border-gray-700">
          <a href="/logout" class="flex items-center gap-3 px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors w-full">
            <span class="material-symbols-outlined">logout</span>
            <span class="font-medium">Logout</span>
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

{% block content %}{% endblock %}
<script>
  // Global toast utility and auto-hide for flashed messages
  (function(){

    function hideAfterDelay(el, delay){
      setTimeout(function(){
        try {
          el.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          el.style.opacity = '0';
          el.style.transform = 'translateY(-4px)';
          setTimeout(function(){ el.remove(); }, 400);
        } catch(_) {}
      }, delay);
    }
    document.addEventListener('DOMContentLoaded', function(){
      try {
        document.querySelectorAll('#flash-container .alert-message').forEach(function(msg){ hideAfterDelay(msg, 4500); });
      } catch(_) {}
    });
    window.showToast = function(message, kind){
      var c = document.getElementById('flash-container');
      if (!c) return;
      var wrapper = document.createElement('div');
      var bg; var iconName; var iconClass; var textClass = 'text-gray-800 dark:text-background-light';
      if (kind === 'success') { bg = 'bg-success-light dark:bg-primary/20'; iconName = 'check_circle'; iconClass = 'text-success-dark-text dark:text-primary'; }
      else if (kind === 'error') { bg = 'bg-error-light dark:bg-red-500/20'; iconName = 'error'; iconClass = 'text-error-dark-text dark:text-red-400'; }
      else { bg = 'bg-info-light dark:bg-blue-500/20'; iconName = 'info'; iconClass = 'text-info-dark-text dark:text-blue-400'; }
      wrapper.className = 'alert-message flex items-center gap-4 p-4 rounded-xl shadow-lg ' + bg + ' mt-2';
      var icon = document.createElement('span'); icon.className = 'material-symbols-outlined ' + iconClass; icon.textContent = iconName;
      var text = document.createElement('p'); text.className = textClass + ' font-medium'; text.textContent = message;
      wrapper.appendChild(icon); wrapper.appendChild(text); c.appendChild(wrapper);
      hideAfterDelay(wrapper, 3500);
    };

    // Close mobile menu when clicking outside or pressing escape
    document.addEventListener('click', function(e) {
        const mobileMenu = document.getElementById('mobile-menu');
        const menuButton = document.getElementById('mobile-menu-button');

        if (mobileMenu && !mobileMenu.classList.contains('translate-x-full') &&
            !mobileMenu.contains(e.target) && !menuButton?.contains(e.target)) {
            window.toggleMobileMenu();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('translate-x-full')) {
                window.toggleMobileMenu();
            }
        }
    });
  })();
</script>

<!-- Mobile menu toggle functionality (global) -->
<script>
window.toggleMobileMenu = function() {
    console.log('toggleMobileMenu called');
    const mobileMenu = document.getElementById('mobile-menu');
    const button = document.getElementById('mobile-menu-button');
    const line1 = document.getElementById('hamburger-line-1');
    const line2 = document.getElementById('hamburger-line-2');
    const line3 = document.getElementById('hamburger-line-3');

    console.log('Elements found:', { mobileMenu, button, line1, line2, line3 });

    if (!mobileMenu) {
        console.error('Mobile menu element not found!');
        return;
    }

    const isOpen = !mobileMenu.classList.contains('translate-x-full');
    console.log('Menu is open:', isOpen);

    if (isOpen) {
        console.log('Closing menu');
        // Close menu
        mobileMenu.classList.add('translate-x-full');
        mobileMenu.classList.remove('translate-x-0');

        // Reset hamburger to normal state
        line1?.classList.remove('rotate-45', 'translate-y-2');
        line2?.classList.remove('opacity-0');
        line3?.classList.remove('-rotate-45', '-translate-y-2');

        // Re-enable body scroll
        document.body.style.overflow = '';
    } else {
        console.log('Opening menu');
        // Open menu
        mobileMenu.classList.remove('translate-x-full');
        mobileMenu.classList.add('translate-x-0');

        // Transform hamburger to X
        line1?.classList.add('rotate-45', 'translate-y-2');
        line2?.classList.add('opacity-0');
        line3?.classList.add('-rotate-45', '-translate-y-2');

        // Prevent body scroll when menu is open
        document.body.style.overflow = 'hidden';
    }
};
</script>

<!-- Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);

          // Check for updates
          registration.addEventListener('updatefound', function() {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Show update notification
                  if (confirm('New version available! Click OK to refresh and use the latest version.')) {
                    window.location.reload();
                  }
                }
              });
            }
          });
        })
        .catch(function(error) {
          console.log('ServiceWorker registration failed: ', error);
        });
    });
  }
</script>
</body>
</html>