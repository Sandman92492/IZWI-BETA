<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>iZwi - Create Your Community</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#2A9D8F",
              "background-light": "#F8F9FA",
              "background-dark": "#1A202C",
              "content-light": "#111827",
              "content-dark": "#F8F9FA",
              "subtle-light": "#E5E7EB",
              "subtle-dark": "#4A5568",
              "placeholder-light": "#9CA3AF",
              "placeholder-dark": "#718096",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "0.75rem",
              full: "9999px",
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from { transform: translateY(10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      /* Map container fixes */
      #community-map {
        min-height: 400px;
        height: 100%;
        z-index: 1;
      }

      /* Mobile map optimizations */
      @media (max-width: 768px) {
        #community-map {
          min-height: 350px;
          height: calc(100vh - 280px); /* Account for header, controls, and bottom CTA */
          touch-action: pan-x pan-y; /* Better touch handling */
        }

        /* Mobile-specific map controls */
        .leaflet-control-container {
          font-size: 16px;
        }

        .leaflet-control-zoom {
          display: none; /* Hide zoom controls on mobile, use pinch instead */
        }

        /* Better mobile overlays */
        .map-instructions {
          font-size: 14px;
          padding: 12px;
          max-width: calc(100vw - 32px);
        }

        /* Mobile-friendly buttons */
        .mobile-cta button {
          min-height: 48px;
          font-size: 16px;
        }

        /* Improve touch targets */
        .leaflet-draw-toolbar a {
          width: 44px !important;
          height: 44px !important;
          line-height: 44px !important;
        }

        /* Better spacing for mobile */
        #step-3 .p-4 {
          padding: 16px;
        }
      }

      /* Desktop map optimizations */
      @media (min-width: 769px) {
        #community-map {
          min-height: 500px;
        }
      }

      /* Map loading state */
      .map-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        background: #f8f9fa;
        color: #6b7280;
        font-size: 16px;
      }

      .map-loading.hidden {
        display: none;
      }

      /* Leaflet-Geoman mobile optimizations */
      @media (max-width: 768px) {
        /* Larger touch targets for Geoman controls */
        .leaflet-pm-toolbar {
          min-height: 50px;
        }

        .leaflet-pm-draw-button {
          width: 50px !important;
          height: 50px !important;
          margin: 4px !important;
          font-size: 18px !important;
        }

        .leaflet-pm-draw-button:before {
          font-size: 20px !important;
        }

        /* Better hint line for mobile */
        .leaflet-pm-draw-hint {
          font-size: 14px;
          padding: 8px 12px;
        }

        /* Larger edit handles */
        .leaflet-pm-marker {
          transform: scale(1.5);
        }

        /* Better vertex markers */
        .leaflet-pm-edit-marker {
          width: 20px !important;
          height: 20px !important;
          margin-left: -10px !important;
          margin-top: -10px !important;
        }
      }

      /* Leaflet.Draw toolbar styling */
      .leaflet-draw-toolbar {
        background-color: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(10px) !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        border: none !important;
        padding: 8px !important;
      }

      .leaflet-draw-toolbar a {
        background-color: #2A9D8F !important;
        color: white !important;
        border-radius: 6px !important;
        transition: all 0.2s ease !important;
        width: 44px !important;
        height: 44px !important;
        line-height: 44px !important;
        margin: 2px !important;
        border: none !important;
        font-size: 16px !important;
      }

      .leaflet-draw-toolbar a:hover {
        background-color: #238a7e !important;
        transform: translateY(-1px);
      }

      .leaflet-draw-toolbar a.active {
        background-color: #1f7669 !important;
        box-shadow: 0 2px 8px rgba(42, 157, 143, 0.3);
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
      }

      .step-indicator {
        transition: all 0.3s ease;
      }

      .step-active {
        background-color: #2A9D8F !important;
        color: white !important;
      }
    </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display text-content-light dark:text-content-dark">
<div id="flash-container" class="fixed top-4 inset-x-0 z-50 flex justify-center px-4">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="space-y-3 max-w-md w-full animate-fade-in">
      {% for category, message in messages %}
        <div class="alert-message flex items-start gap-3 p-4 rounded-lg shadow-lg {% if category == 'success' %}bg-green-50 text-green-800 dark:bg-green-900/20 dark:text-green-200{% elif category == 'error' %}bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200{% else %}bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200{% endif %} border-l-4 {% if category == 'success' %}border-green-500{% elif category == 'error' %}border-red-500{% else %}border-yellow-500{% endif %}" role="alert">
          <span class="material-symbols-outlined mt-0.5 {% if category == 'success' %}text-green-600{% elif category == 'error' %}text-red-600{% else %}text-yellow-600{% endif %}">{% if category == 'success' %}check_circle{% elif category == 'error' %}error{% else %}warning{% endif %}</span>
          <span class="text-base font-normal">{{ message }}</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
</div>

<!-- Progress Header -->
<div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
  <div class="max-w-4xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('index') }}" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          <span class="text-sm">Back to Home</span>
        </a>
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('logout') }}" class="text-sm px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
          Switch Account
        </a>
      </div>
    </div>

    <!-- Enhanced Progress Steps -->
    <div class="flex items-center justify-center space-x-4">
      <div class="flex items-center">
        <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold step-indicator step-active">1</div>
        <span class="ml-2 text-sm font-medium text-gray-900 dark:text-white">Purpose</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold step-indicator">2</div>
        <span class="ml-2 text-sm font-medium text-gray-500">Name</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold step-indicator">3</div>
        <span class="ml-2 text-sm font-medium text-gray-500">Location</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold step-indicator">4</div>
        <span class="ml-2 text-sm font-medium text-gray-500">Create</span>
      </div>
    </div>
  </div>
</div>

<div class="flex flex-col lg:flex-row min-h-screen">
  <!-- Instructions Panel - Mobile & Desktop -->
  <div class="w-full lg:w-80 bg-white dark:bg-gray-800 border-b lg:border-b-0 lg:border-r border-gray-200 dark:border-gray-700 p-4 lg:p-6 order-1 lg:order-1">
    <div class="lg:sticky lg:top-6">
      <!-- Mobile/Tablet Instructions -->
      <div class="lg:hidden mb-4">
        <div class="bg-primary/10 rounded-lg p-4 mb-4">
          <div class="flex items-center mb-2">
            <span class="material-symbols-outlined text-primary mr-2">info</span>
            <h3 class="font-medium text-gray-900 dark:text-white">How to Create Your Community</h3>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-300 space-y-2">
            <p><strong>Step 1:</strong> Enter your community name</p>
            <p><strong>Step 2:</strong> Draw a boundary on the map to define your area</p>
            <p><strong>Step 3:</strong> Create your community!</p>
          </div>
        </div>
      </div>

      <!-- Desktop Instructions -->
      <div class="hidden lg:block">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Community Setup Guide</h2>

        <!-- Step 1 -->
        <div class="mb-6 p-4 bg-primary/10 rounded-lg">
          <div class="flex items-center mb-2">
            <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs font-semibold mr-2">1</span>
            <h3 class="font-medium text-gray-900 dark:text-white">Name Your Community</h3>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Give your community a clear, recognizable name that reflects your neighborhood or area.
          </p>
        </div>

        <!-- Step 2 -->
        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
          <div class="flex items-center mb-2">
            <span class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs font-semibold mr-2">2</span>
            <h3 class="font-medium text-gray-900 dark:text-white">Define Location</h3>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Draw a boundary around your community area on the map. This helps focus alerts to your local area.
          </p>
        </div>

        <!-- Tips -->
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
          <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center">
            <span class="material-symbols-outlined text-blue-500 mr-2 text-sm">lightbulb</span>
            Pro Tips
          </h4>
          <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
            <li>• Include major streets or landmarks</li>
            <li>• Start with a rough outline and refine</li>
            <li>• You can always adjust boundaries later</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col order-2 lg:order-2">
    <!-- Step 1: Welcome & Purpose -->
    <div id="step-1" class="flex-1 p-6">
      <div class="max-w-3xl mx-auto">
        <div class="text-center mb-8">
          <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="text-4xl">🏘️</span>
          </div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Create Your Community</h1>
          <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">Build a local alert network to connect with neighbors and stay informed about what's happening in your area.</p>
        </div>

        <!-- Community Examples -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="flex items-center mb-3">
              <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center mr-3">
                <span class="text-blue-600 dark:text-blue-400">🏙️</span>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white">Neighborhood Community</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Residential area</p>
              </div>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
              Connect with neighbors in your apartment building, street, or local area to share local news and safety alerts.
            </p>
            <div class="flex flex-wrap gap-2">
              <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-xs rounded-full">Local Events</span>
              <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-xs rounded-full">Safety Alerts</span>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
            <div class="flex items-center mb-3">
              <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center mr-3">
                <span class="text-green-600 dark:text-green-400">🏢</span>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white">Business District</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Commercial area</p>
              </div>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
              Coordinate with local businesses, manage security alerts, and keep the business community informed.
            </p>
            <div class="flex flex-wrap gap-2">
              <span class="px-2 py-1 bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-200 text-xs rounded-full">Business Alerts</span>
              <span class="px-2 py-1 bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-200 text-xs rounded-full">Security</span>
            </div>
          </div>
        </div>

        <!-- What You'll Get -->
        <div class="bg-primary/5 rounded-xl p-6 mb-8">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-4 text-center">What you'll get with your community:</h3>
          <div class="grid sm:grid-cols-2 gap-4 text-sm">
            <div class="flex items-center">
              <span class="text-primary mr-3">✅</span>
              <span class="text-gray-700 dark:text-gray-300">Real-time alert notifications</span>
            </div>
            <div class="flex items-center">
              <span class="text-primary mr-3">✅</span>
              <span class="text-gray-700 dark:text-gray-300">Interactive community map</span>
            </div>
            <div class="flex items-center">
              <span class="text-primary mr-3">✅</span>
              <span class="text-gray-700 dark:text-gray-300">Member management tools</span>
            </div>
            <div class="flex items-center">
              <span class="text-primary mr-3">✅</span>
              <span class="text-gray-700 dark:text-gray-300">Community invite system</span>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <div class="text-center">
          <button type="button" onclick="nextStep()" class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium text-lg">
            Let's Get Started →
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Community Name -->
    <div id="step-2" class="flex-1 hidden p-6">
      <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">What's your community called?</h1>
          <p class="text-gray-600 dark:text-gray-300">Choose a name that represents your neighborhood or local area</p>
        </div>

        <form method="POST" class="space-y-6">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="community-name">
              Community Name *
            </label>
            <input class="w-full h-12 px-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" id="community-name" name="community_name" placeholder="e.g., Downtown Community, Riverdale Neighborhood" type="text" required/>
            <div class="mt-2 space-y-1">
              <div class="flex items-center text-xs">
                <span id="name-length-check" class="flex items-center text-gray-400">○</span>
                <span class="ml-1">3-50 characters</span>
              </div>
              <div class="flex items-center text-xs">
                <span id="name-unique-check" class="flex items-center text-gray-400">○</span>
                <span class="ml-1">Unique name</span>
              </div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This name will be visible to all community members</p>
          </div>

          <!-- Name Suggestions -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
            <h4 class="font-medium text-gray-900 dark:text-white mb-2 text-sm">💡 Name Ideas</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <button type="button" class="text-left text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors" onclick="setCommunityName('My Neighborhood')">
                My Neighborhood
              </button>
              <button type="button" class="text-left text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors" onclick="setCommunityName('Local Community')">
                Local Community
              </button>
              <button type="button" class="text-left text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors" onclick="setCommunityName('Street Watch')">
                Street Watch
              </button>
              <button type="button" class="text-left text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors" onclick="setCommunityName('Community Alerts')">
                Community Alerts
              </button>
            </div>
          </div>

          <input type="hidden" name="boundary_data" id="boundary_data">

          <!-- Navigation Buttons -->
          <div class="flex justify-between pt-4">
            <button type="button" onclick="prevStep()" class="px-6 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              ← Back
            </button>
            <button type="button" onclick="nextStep()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
              Continue to Location →
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Step 3: Map Interface -->
    <div id="step-3" class="flex-1 hidden">
      <div class="h-full flex flex-col">
        <!-- Map Controls -->
        <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
          <div class="flex flex-wrap gap-3 items-center justify-between">
            <div class="flex gap-3">
              <input id="addressSearchDefine" type="text" placeholder="Search for address or landmark..."
                     class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary focus:border-primary text-sm flex-1 min-w-48">
              <button type="button" onclick="searchAddressDefine()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm font-medium">
                Search
              </button>
            </div>
            <button type="button" onclick="useMyLocationDefine()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
              <span class="material-symbols-outlined text-sm">my_location</span>
              Use My Location
            </button>
          </div>
        </div>

        <!-- Map Container -->
        <div class="flex-1 relative">
          <!-- Map Loading State -->
          <div id="map-loading" class="map-loading">
            <div class="flex items-center gap-3">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
              <span>Loading map...</span>
            </div>
          </div>
          <!-- Actual Map -->
          <div id="community-map" class="w-full h-full"></div>

          <!-- Map Instructions - Enhanced for Mobile -->
          <div class="absolute top-4 left-4 right-4 lg:left-4 lg:right-auto bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg p-3 sm:p-4 shadow-lg map-instructions">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center mt-0.5">
                <span class="material-symbols-outlined text-primary text-lg">edit</span>
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base mb-1">Draw Your Community Boundary</h3>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
                  <strong>How:</strong> Tap on the map to add points around your community area. Double-tap to finish.
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  💡 <strong>Tip:</strong> Include streets, parks, or landmarks to define your area clearly.
                </p>
              </div>
            </div>
          </div>

          <!-- Drawing Status & CTA -->
          <div class="absolute bottom-4 left-4 right-4 lg:left-4 lg:right-auto" id="drawing-status-container">
            <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-lg p-3 sm:p-4 shadow-lg">
              <div class="flex items-start gap-3" id="status-content">
                <div class="flex-shrink-0 w-6 h-6 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                  <span class="material-symbols-outlined text-gray-500 text-sm">info</span>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-600 dark:text-gray-300" id="status-message">
                    Ready to draw! Use the drawing tools (circle, rectangle, or polygon) to define your community boundary.
                  </p>
                </div>
              </div>

              <!-- Prominent CTA Buttons for Mobile -->
              <div class="mt-3 lg:hidden mobile-cta" id="mobile-cta">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Choose your drawing method:</p>
                <div class="grid grid-cols-3 gap-2 mb-3">
                  <button type="button" onclick="startCircleDraw()"
                          class="bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 rounded-lg flex flex-col items-center justify-center gap-1 text-sm font-medium min-h-[60px]">
                    <span class="material-symbols-outlined text-lg">radio_button_unchecked</span>
                    <div class="text-center">
                      <div class="font-medium">Circle</div>
                      <div class="text-xs text-green-500">Easiest</div>
                    </div>
                  </button>
                  <button type="button" onclick="startRectangleDraw()"
                          class="bg-purple-50 text-purple-600 hover:bg-purple-100 border border-purple-200 rounded-lg flex flex-col items-center justify-center gap-1 text-sm font-medium min-h-[60px]">
                    <span class="material-symbols-outlined text-lg">square</span>
                    <div class="text-center">
                      <div class="font-medium">Rectangle</div>
                      <div class="text-xs text-purple-500">Simple</div>
                    </div>
                  </button>
                  <button type="button" onclick="startDrawingMode()"
                          class="bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 rounded-lg flex flex-col items-center justify-center gap-1 text-sm font-medium min-h-[60px]">
                    <span class="material-symbols-outlined text-lg">edit</span>
                    <div class="text-center">
                      <div class="font-medium">Polygon</div>
                      <div class="text-xs text-blue-500">Custom</div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step Navigation -->
        <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
          <div class="flex justify-between items-center">
            <button type="button" onclick="prevStep()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              Back to Name
            </button>
            <div class="flex gap-3">
              <button type="button" onclick="skipBoundary()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
                Skip for now
              </button>
              <button type="button" onclick="nextStep()" id="continue-btn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Continue to Review →
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Review & Create -->
    <div id="step-4" class="flex-1 hidden p-6">
      <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
          <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="text-4xl">✨</span>
          </div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Ready to Create Your Community?</h1>
          <p class="text-gray-600 dark:text-gray-300">Review your settings and create your community</p>
        </div>

        <!-- Review Summary -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm mb-6">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-4 text-center">Community Summary</h3>

          <div class="space-y-4">
            <div class="flex justify-between items-center py-3 border-b border-gray-100 dark:border-gray-700">
              <span class="font-medium text-gray-700 dark:text-gray-300">Community Name:</span>
              <span id="review-name" class="text-gray-900 dark:text-white font-semibold">-</span>
            </div>

            <div class="flex justify-between items-center py-3 border-b border-gray-100 dark:border-gray-700">
              <span class="font-medium text-gray-700 dark:text-gray-300">Location:</span>
              <span id="review-location" class="text-gray-900 dark:text-white">
                <span id="review-area">-</span>
                {% if hasBoundary %}
                  <span class="text-sm text-green-600 dark:text-green-400 ml-2">✓ Boundary defined</span>
                {% else %}
                  <span class="text-sm text-gray-500 ml-2">No boundary (global)</span>
                {% endif %}
              </span>
            </div>

            <div class="flex justify-between items-center py-3 border-b border-gray-100 dark:border-gray-700">
              <span class="font-medium text-gray-700 dark:text-gray-300">Your Role:</span>
              <span class="text-gray-900 dark:text-white font-semibold">Community Admin</span>
            </div>

            <div class="flex justify-between items-center py-3">
              <span class="font-medium text-gray-700 dark:text-gray-300">Features:</span>
              <div class="text-right">
                <div class="text-green-600 dark:text-green-400 text-sm">✓ Real-time alerts</div>
                <div class="text-green-600 dark:text-green-400 text-sm">✓ Interactive map</div>
                <div class="text-green-600 dark:text-green-400 text-sm">✓ Member management</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Final Confirmation -->
        <div class="bg-primary/5 rounded-xl p-4 mb-6">
          <div class="flex items-start gap-3">
            <div class="w-6 h-6 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
              <span class="text-primary text-sm">ℹ️</span>
            </div>
            <div>
              <h4 class="font-medium text-gray-900 dark:text-white mb-1 text-sm">What happens next?</h4>
              <p class="text-xs text-gray-600 dark:text-gray-300">
                Your community will be created immediately. You'll become the admin and can start inviting neighbors right away.
                You can always modify settings and boundaries later from your dashboard.
              </p>
            </div>
          </div>
        </div>

        <form method="POST" class="space-y-4">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="community_name" id="final-community-name">
          <input type="hidden" name="boundary_data" id="final-boundary-data">

          <!-- Navigation Buttons -->
          <div class="flex justify-between pt-4">
            <button type="button" onclick="prevStep()" class="px-6 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              ← Back to Location
            </button>
            <button type="submit" onclick="finalizeCommunity()" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-lg">
              Create My Community →
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Step management
let currentStep = 1;
let totalSteps = 4;
let communityMap = null;
let drawnItems = null;
let hasBoundary = false;
let communityName = '';
let boundaryData = '';

// No external dependencies needed - using self-contained Leaflet drawing

// Self-contained drawing solution - no external dependencies needed

// Simple circle drawing (click center, drag radius)
function startSimpleCircleDraw() {
    if (!communityMap) return;

    let centerMarker = null;
    let radius = 0;

    communityMap.getContainer().style.cursor = 'crosshair';

    function onMapClick(e) {
        if (!centerMarker) {
            // First click - set center
            centerMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'center-marker',
                    html: '<div style="background: #10b981; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(communityMap);

            communityMap.off('click', onMapClick);
            communityMap.on('mousemove', onMapMove);
        }
    }

    function onMapMove(e) {
        if (centerMarker) {
            radius = communityMap.distance(centerMarker.getLatLng(), e.latlng);
            updateCirclePreview(centerMarker.getLatLng(), radius);
        }
    }

    function updateCirclePreview(center, radius) {
        // Remove existing preview
        communityMap.eachLayer(layer => {
            if (layer.options && layer.options.className === 'circle-preview') {
                communityMap.removeLayer(layer);
            }
        });

        // Add new preview circle
        L.circle(center, radius, {
            className: 'circle-preview',
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.2,
            weight: 2
        }).addTo(communityMap);
    }

    communityMap.on('click', onMapClick);

    // Finish drawing on double click or after delay
    setTimeout(() => {
        communityMap.off('click', onMapClick);
        communityMap.off('mousemove', onMapMove);
        communityMap.getContainer().style.cursor = '';

        if (centerMarker && radius > 0) {
            // Create final circle
            const finalCircle = L.circle(centerMarker.getLatLng(), radius, {
                color: '#10b981',
                fillColor: '#10b981',
                fillOpacity: 0.3,
                weight: 2
            });

            drawnItems.clearLayers();
            drawnItems.addLayer(finalCircle);

            // Store boundary data
            boundaryData = finalCircle.toGeoJSON();
            document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
            hasBoundary = true;
            updateContinueButton();

            updateDrawingStatus('Circle boundary created! You can edit it or continue.');
        }
    }, 10000); // 10 second timeout
}

// Simple rectangle drawing (click two corners)
function startSimpleRectangleDraw() {
    if (!communityMap) return;

    let corner1 = null;
    let corner2 = null;

    communityMap.getContainer().style.cursor = 'crosshair';

    function onMapClick(e) {
        if (!corner1) {
            corner1 = e.latlng;
        } else if (!corner2) {
            corner2 = e.latlng;
            communityMap.off('click', onMapClick);
            communityMap.getContainer().style.cursor = '';

            // Create rectangle
            const bounds = L.latLngBounds(corner1, corner2);
            const rectangle = L.rectangle(bounds, {
                color: '#8b5cf6',
                fillColor: '#8b5cf6',
                fillOpacity: 0.3,
                weight: 2
            });

            drawnItems.clearLayers();
            drawnItems.addLayer(rectangle);

            // Store boundary data
            boundaryData = rectangle.toGeoJSON();
            document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
            hasBoundary = true;
            updateContinueButton();

            updateDrawingStatus('Rectangle boundary created! You can edit it or continue.');
        }
    }

    communityMap.on('click', onMapClick);
}

// Simple polygon drawing (click points, double-click to finish)
function startSimplePolygonDraw() {
    if (!communityMap) return;

    const polygonPoints = [];
    communityMap.getContainer().style.cursor = 'crosshair';

    function onMapClick(e) {
        polygonPoints.push(e.latlng);

        // Add marker for visual feedback
        L.marker(e.latlng, {
            icon: L.divIcon({
                className: 'polygon-point',
                html: `<div style="background: #3b82f6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [12, 12]
            })
        }).addTo(communityMap);

        // Update preview line
        updatePolygonPreview(polygonPoints);
    }

    function updatePolygonPreview(points) {
        // Remove existing preview
        communityMap.eachLayer(layer => {
            if (layer.options && layer.options.className === 'polygon-preview') {
                communityMap.removeLayer(layer);
            }
        });

        if (points.length > 1) {
            // Add preview polygon
            L.polygon(points, {
                className: 'polygon-preview',
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(communityMap);
        }
    }

    function onMapDblClick(e) {
        if (polygonPoints.length >= 3) {
            communityMap.off('click', onMapClick);
            communityMap.off('dblclick', onMapDblClick);
            communityMap.getContainer().style.cursor = '';

            // Create final polygon
            const polygon = L.polygon(polygonPoints, {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.3,
                weight: 2
            });

            drawnItems.clearLayers();
            drawnItems.addLayer(polygon);

            // Store boundary data
            boundaryData = polygon.toGeoJSON();
            document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
            hasBoundary = true;
            updateContinueButton();

            updateDrawingStatus('Polygon boundary created! You can edit it or continue.');
        }
    }

    communityMap.on('click', onMapClick);
    communityMap.on('dblclick', onMapDblClick);

    // Auto-finish after 30 seconds
    setTimeout(() => {
        if (polygonPoints.length >= 3) {
            communityMap.off('click', onMapClick);
            communityMap.off('dblclick', onMapDblClick);
            communityMap.getContainer().style.cursor = '';

            const polygon = L.polygon(polygonPoints, {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.3,
                weight: 2
            });

            drawnItems.clearLayers();
            drawnItems.addLayer(polygon);

            boundaryData = polygon.toGeoJSON();
            document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
            hasBoundary = true;
            updateContinueButton();

            updateDrawingStatus('Polygon boundary created! You can edit it or continue.');
        }
    }, 30000);
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    setupEventListeners();
    updateStepIndicator();

    // Auto-hide flash messages after 5 seconds
    const alertMessages = document.querySelectorAll('.alert-message');
    const flashContainer = document.getElementById('flash-container');
    alertMessages.forEach(function(message) {
        setTimeout(function() {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
                if (flashContainer && !flashContainer.querySelector('.alert-message')) {
                    flashContainer.remove();
                }
            }, 500);
        }, 5000);
    });
});

// Mobile detection helper
function isMobileDevice() {
    return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (window.innerWidth <= 768);
}

// Show/hide map loading state
function showMapLoading(show = true) {
    const loadingEl = document.getElementById('map-loading');
    const mapEl = document.getElementById('community-map');

    if (show) {
        loadingEl.classList.remove('hidden');
        if (mapEl) mapEl.style.display = 'none';
    } else {
        loadingEl.classList.add('hidden');
        if (mapEl) mapEl.style.display = 'block';
    }
}

// Initialize the map
function initializeMap() {
    const isMobile = isMobileDevice();
    showMapLoading(true);

    try {
        // Initialize the community boundary map with mobile optimizations
        const mapOptions = {
            gestureHandling: true,
            zoomControl: !isMobile, // Hide zoom controls on mobile, use pinch instead
            scrollWheelZoom: !isMobile,
            doubleClickZoom: !isMobile,
            dragging: !isMobile, // Disable dragging on mobile initially
            tap: isMobile, // Enable tap on mobile
            touchZoom: isMobile,
            boxZoom: !isMobile,
            zoomAnimation: true,
            fadeAnimation: true,
            markerZoomAnimation: true
        };

        communityMap = L.map('community-map', mapOptions).setView([-26.2041, 28.0473], isMobile ? 12 : 13);

        // Add tile layer with error handling
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
            errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
        }).addTo(communityMap);

        // Initialize the FeatureGroup to store editable layers
        drawnItems = new L.FeatureGroup();
        communityMap.addLayer(drawnItems);

        // Initialize custom drawing controls (self-contained, no external dependencies)
        initializeCustomDrawing();

        // Debug: Check if drawing system is ready
        console.log('Custom drawing system initialized');
        console.log('Map object:', communityMap);

        // Add gesture handling for mobile
        if (isMobile) {
            communityMap.addHandler('gestureHandling', L.GestureHandling);
        }

        // Map loaded successfully
        communityMap.whenReady(function() {
            showMapLoading(false);

            // Re-enable dragging after map loads on mobile
            if (isMobile) {
                communityMap.dragging.enable();
                communityMap.touchZoom.enable();
                communityMap.doubleClickZoom.enable();
            }

            // Add mobile-specific styling
            if (isMobile) {
                addMobileMapStyling();
            }
        });

        // Handle map load errors
        communityMap.on('error', function(e) {
            showMapLoading(false);
            showAlert('Failed to load map. Please check your internet connection and try again.', 'error');
            console.error('Map load error:', e);
        });

    } catch (error) {
        showMapLoading(false);
        showAlert('Failed to initialize map. Please refresh the page and try again.', 'error');
        console.error('Map initialization error:', error);
    }
}

// Add mobile-specific map styling
function addMobileMapStyling() {
    const style = document.createElement('style');
    style.textContent = `
        .leaflet-draw-toolbar a {
            width: 44px !important;
            height: 44px !important;
            line-height: 44px !important;
        }

        .leaflet-touch .leaflet-draw-toolbar a {
            width: 50px !important;
            height: 50px !important;
            line-height: 50px !important;
        }

        .leaflet-draw-section {
            margin-bottom: 10px;
        }

        .custom-polygon-marker {
            background: #2A9D8F !important;
            border: 3px solid white !important;
            border-radius: 50% !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }
    `;
    document.head.appendChild(style);
}

    // Handle Leaflet.Draw events
    communityMap.on(L.Draw.Event.CREATED, function (e) {
        const layer = e.layer;

        // Clear existing drawings (only allow one boundary)
        drawnItems.clearLayers();

        // Add the new boundary
        drawnItems.addLayer(layer);

        // Store boundary data globally and in form
        boundaryData = layer.toGeoJSON();
        document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
        hasBoundary = true;
        updateContinueButton();

        // Update status with better mobile messaging
        const shapeType = e.layerType || 'boundary';
        updateDrawingStatus(`${shapeType.charAt(0).toUpperCase() + shapeType.slice(1)} boundary created! You can edit it or continue.`);
    });

    communityMap.on(L.Draw.Event.EDITED, function (e) {
        const layers = e.layers;
        layers.eachLayer(function (layer) {
            boundaryData = layer.toGeoJSON();
            document.getElementById('boundary_data').value = JSON.stringify(boundaryData);
            hasBoundary = true;
            updateContinueButton();
        });
    });

    communityMap.on(L.Draw.Event.DELETED, function (e) {
        document.getElementById('boundary_data').value = '';
        hasBoundary = false;
        updateContinueButton();
        updateDrawingStatus('Ready to draw! Choose circle, rectangle, or polygon tool to define your community boundary.');
    });

    // Get user's current location for initial map center
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                communityMap.setView([lat, lng], 15);

                // Add a marker to show user's location
                L.marker([lat, lng]).addTo(communityMap)
                    .bindPopup('Your current location')
                    .openPopup();
            },
            function(error) {
                console.log('Geolocation error:', error);
                // Stay with default coordinates if geolocation fails
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
    }

// Step navigation functions
function nextStep() {
    if (currentStep === 1) {
        // Move to step 2 (Community Name)
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        currentStep = 2;
        updateStepIndicator();
    } else if (currentStep === 2) {
        // Validate community name and move to step 3 (Location)
        communityName = document.getElementById('community-name').value.trim();
        if (!communityName) {
            showAlert('Please enter a community name', 'error');
            return;
        }

        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-3').classList.remove('hidden');
        currentStep = 3;
        updateStepIndicator();

        // Focus map after transition with better mobile handling
        setTimeout(() => {
            if (communityMap) {
                communityMap.invalidateSize();

                // Additional mobile-specific resize handling
                if (isMobileDevice()) {
                    setTimeout(() => {
                        communityMap.invalidateSize();
                        if (communityMap._container) {
                            communityMap._container.style.height = '100%';
                        }
                    }, 300);
                }
            }
        }, 100);
    } else if (currentStep === 3) {
        // Move to step 4 (Review)
        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('step-4').classList.remove('hidden');
        currentStep = 4;
        updateStepIndicator();
        updateReviewStep();
    }
}

function prevStep() {
    if (currentStep === 2) {
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-1').classList.remove('hidden');
        currentStep = 1;
        updateStepIndicator();
    } else if (currentStep === 3) {
        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        currentStep = 2;
        updateStepIndicator();
    } else if (currentStep === 4) {
        document.getElementById('step-4').classList.add('hidden');
        document.getElementById('step-3').classList.remove('hidden');
        currentStep = 3;
        updateStepIndicator();
    }
}

function updateStepIndicator() {
    // Update step indicators
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        if (index + 1 === currentStep) {
            indicator.classList.add('step-active');
            indicator.classList.remove('bg-gray-200', 'text-gray-500');
            indicator.classList.add('bg-primary', 'text-white');
        } else {
            indicator.classList.remove('step-active');
            indicator.classList.add('bg-gray-200', 'text-gray-500');
            indicator.classList.remove('bg-primary', 'text-white');
        }
    });

    // Update step labels
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const label = indicator.nextElementSibling;
        if (index + 1 === currentStep) {
            label.classList.remove('text-gray-500');
            label.classList.add('text-gray-900', 'dark:text-white');
        } else {
            label.classList.add('text-gray-500');
            label.classList.remove('text-gray-900', 'dark:text-white');
        }
    });
}

// New functions for community name validation and suggestions
function setCommunityName(name) {
    document.getElementById('community-name').value = name;
    validateCommunityName();
}

function validateCommunityName() {
    const nameInput = document.getElementById('community-name');
    const lengthCheck = document.getElementById('name-length-check');
    const uniqueCheck = document.getElementById('name-unique-check');

    const name = nameInput.value.trim();

    // Length validation (3-50 characters)
    if (name.length >= 3 && name.length <= 50) {
        lengthCheck.innerHTML = '✓';
        lengthCheck.className = 'flex items-center text-green-500';
    } else if (name.length > 0) {
        lengthCheck.innerHTML = '○';
        lengthCheck.className = 'flex items-center text-gray-400';
    } else {
        lengthCheck.innerHTML = '○';
        lengthCheck.className = 'flex items-center text-gray-400';
    }

    // Basic uniqueness check (client-side only for now)
    if (name.length >= 3) {
        uniqueCheck.innerHTML = '✓';
        uniqueCheck.className = 'flex items-center text-green-500';
    } else {
        uniqueCheck.innerHTML = '○';
        uniqueCheck.className = 'flex items-center text-gray-400';
    }
}

// Review step functions
function updateReviewStep() {
    // Update review information
    document.getElementById('review-name').textContent = communityName;

    const areaElement = document.getElementById('review-area');
    if (hasBoundary && drawnItems && drawnItems.getLayers().length > 0) {
        const layer = drawnItems.getLayers()[0];
        if (layer.getBounds) {
            const bounds = layer.getBounds();
            const center = bounds.getCenter();
            areaElement.textContent = `Lat: ${center.lat.toFixed(4)}, Lng: ${center.lng.toFixed(4)}`;
        } else {
            areaElement.textContent = 'Custom area defined';
        }
    } else {
        areaElement.textContent = 'Global (no boundary)';
    }
}

function finalizeCommunity() {
    // Set final form values
    document.getElementById('final-community-name').value = communityName;
    document.getElementById('final-boundary-data').value = boundaryData || '';

    // Show loading state
    const submitBtn = document.querySelector('#step-4 button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    submitBtn.textContent = 'Creating Community...';

    // Submit form after a brief delay for visual feedback
    setTimeout(() => {
        submitBtn.closest('form').submit();
    }, 500);
}

function updateContinueButton() {
    const continueBtn = document.getElementById('continue-btn');
    if (hasBoundary) {
        continueBtn.disabled = false;
        continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        continueBtn.disabled = true;
        continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function updateDrawingStatus(message) {
    const statusEl = document.getElementById('status-message');
    const statusContent = document.getElementById('status-content');
    const mobileCta = document.getElementById('mobile-cta');

    if (statusEl) {
        statusEl.textContent = message;
    }

    // Show/hide mobile CTA based on whether boundary exists
    if (mobileCta) {
        if (hasBoundary) {
            mobileCta.style.display = 'none';
            if (statusContent) {
                statusContent.classList.remove('pb-3');
            }
        } else {
            mobileCta.style.display = 'block';
            if (statusContent) {
                statusContent.classList.add('pb-3');
            }
        }
    }
}

// Mobile detection function
function isMobileDevice() {
    return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
}

// Leaflet.Draw drawing functions using official library

// Circle drawing function
function startCircleDraw() {
    if (!communityMap) return;

    const circleDraw = new L.Draw.Circle(communityMap, {
        shapeOptions: {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.3,
            weight: 2
        }
    });
    circleDraw.enable();

    updateDrawingStatus('Click to set center point, then drag to adjust radius.');
    hideMobileCta();
}

// Rectangle drawing function
function startRectangleDraw() {
    if (!communityMap) return;

    const rectDraw = new L.Draw.Rectangle(communityMap, {
        shapeOptions: {
            color: '#8b5cf6',
            fillColor: '#8b5cf6',
            fillOpacity: 0.3,
            weight: 2
        }
    });
    rectDraw.enable();

    updateDrawingStatus('Click two corners to create a rectangle.');
    hideMobileCta();
}

// Polygon drawing function
function startDrawingMode() {
    if (!communityMap) return;

    const polyDraw = new L.Draw.Polygon(communityMap, {
        allowIntersection: false,
        shapeOptions: {
            color: '#3b82f6',
            fillColor: '#3b82f6',
            fillOpacity: 0.3,
            weight: 2
        }
    });
    polyDraw.enable();

    updateDrawingStatus('Click to add points (3+ needed). Double-click to finish.');
    hideMobileCta();
}

function skipBoundary() {
    // Set empty boundary and continue
    document.getElementById('boundary_data').value = '';
    hasBoundary = true;
    updateContinueButton();
    createCommunity();
}

function createCommunity() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('continue-btn');
    const originalText = submitBtn.textContent;

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    submitBtn.textContent = 'Creating Community...';

    // Submit form
    form.submit();
}

// Enhanced location helper functions
function useMyLocationDefine() {
    if (!navigator.geolocation) {
        showAlert('Geolocation is not supported by your browser.', 'error');
        return;
    }

    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="material-symbols-outlined animate-spin">location_searching</span> Getting location...';
    button.disabled = true;

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Animate to location with better zoom for mobile
            communityMap.flyTo([lat, lng], isMobileDevice() ? 15 : 16, {
                animate: true,
                duration: 1.5
            });

            // Remove any existing location markers
            communityMap.eachLayer(function(layer) {
                if (layer instanceof L.Marker && layer.getPopup() &&
                    layer.getPopup().getContent() === 'Your current location') {
                    communityMap.removeLayer(layer);
                }
            });

            // Add new location marker with better styling
            const locationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-location-marker',
                    html: '<div style="background-color: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(communityMap);

            locationMarker.bindPopup(`
                <div class="text-center">
                    <strong>Your Location</strong><br>
                    <small class="text-gray-600">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</small>
                </div>
            `).openPopup();

            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;

            showAlert('Location found! You can now draw your community boundary around this area.', 'success');
        },
        function(error) {
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;

            let errorMessage = 'Unable to get your location.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Location access denied. Please enable location permissions and try again.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Location information unavailable. Please check your GPS/network and try again.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Location request timed out. Please try again.';
                    break;
            }
            showAlert(errorMessage, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes
        }
    );
}

function searchAddressDefine() {
    const query = document.getElementById('addressSearchDefine').value.trim();
    if (!query) {
        showAlert('Please enter an address or location to search for.', 'warning');
        return;
    }

    // Show loading state
    const button = event.target;
    const searchInput = document.getElementById('addressSearchDefine');
    const originalButtonText = button.textContent;
    const originalPlaceholder = searchInput.placeholder;

    button.textContent = 'Searching...';
    button.disabled = true;
    searchInput.disabled = true;
    searchInput.placeholder = 'Searching for location...';

    // Use OpenStreetMap Nominatim for geocoding (free, no API key needed)
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=3&countrycodes=za&addressdetails=1`;

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);

                // Animate to location
                communityMap.flyTo([lat, lng], isMobileDevice() ? 14 : 15, {
                    animate: true,
                    duration: 1.5
                });

                // Remove existing search markers
                communityMap.eachLayer(function(layer) {
                    if (layer instanceof L.Marker && layer.getPopup() &&
                        layer.getPopup().getContent().includes('Found:')) {
                        communityMap.removeLayer(layer);
                    }
                });

                // Add enhanced marker for the searched location
                const searchMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'custom-search-marker',
                        html: '<div style="background-color: #10b981; width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    })
                }).addTo(communityMap);

                searchMarker.bindPopup(`
                    <div class="text-sm">
                        <strong>📍 ${result.display_name.split(',')[0]}</strong><br>
                        <small class="text-gray-600">${result.type || 'Location'}</small>
                    </div>
                `).openPopup();

                // Clear the search box
                searchInput.value = '';

                showAlert(`Found: ${result.display_name.split(',')[0]}`, 'success');
            } else {
                showAlert('Location not found. Try: street name, suburb, or landmark.', 'warning');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showAlert('Error searching for location. Please check your connection and try again.', 'error');
        })
        .finally(() => {
            // Reset button and input
            button.textContent = originalButtonText;
            button.disabled = false;
            searchInput.disabled = false;
            searchInput.placeholder = originalPlaceholder;
            searchInput.focus();
        });
}

// Utility functions
function showAlert(message, type = 'info') {
    const flashContainer = document.getElementById('flash-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert-message flex items-start gap-3 p-4 rounded-lg shadow-lg animate-fade-in ${
        type === 'error' ? 'bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200 border-l-4 border-red-500' :
        type === 'warning' ? 'bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200 border-l-4 border-yellow-500' :
        'bg-blue-50 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200 border-l-4 border-blue-500'
    }`;
    alertDiv.innerHTML = `
        <span class="material-symbols-outlined mt-0.5 ${
            type === 'error' ? 'text-red-600' :
            type === 'warning' ? 'text-yellow-600' :
            'text-blue-600'
        }">
            ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'}
        </span>
        <span class="text-base font-normal">${message}</span>
    `;

    if (flashContainer) {
        flashContainer.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.style.transition = 'opacity 0.5s ease-out';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
        }, 5000);
    }
}

// Event listeners
function setupEventListeners() {
    // Enter key to trigger search
    const addressInput = document.getElementById('addressSearchDefine');
    if (addressInput) {
        addressInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchAddressDefine();
            }
        });
    }

    // Community name validation (updated for step 2)
    const communityNameInput = document.getElementById('community-name');
    if (communityNameInput) {
        communityNameInput.addEventListener('input', validateCommunityName);

        // Also validate on focus out
        communityNameInput.addEventListener('blur', validateCommunityName);
    }
}

// Mobile-specific styling and optimizations for Geoman
if (isMobileDevice()) {
    // Add mobile-specific CSS for Geoman
    const style = document.createElement('style');
    style.textContent = `
        .custom-location-marker div {
            animation: pulse 2s infinite;
        }

        .custom-search-marker div {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Leaflet.Draw mobile improvements */
        .leaflet-draw-toolbar {
          background-color: rgba(255, 255, 255, 0.95) !important;
          border-radius: 12px !important;
          padding: 8px !important;
        }

        /* Larger touch targets for mobile */
        .leaflet-draw-toolbar a {
            width: 50px !important;
            height: 50px !important;
            line-height: 50px !important;
            margin: 4px !important;
            transform: scale(1.1) !important;
            font-size: 18px !important;
        }

        /* Better mobile popup styling */
        .leaflet-popup-content-wrapper {
            padding: 12px;
            font-size: 14px;
        }

        .leaflet-popup-tip {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Improve map container touch handling */
        #community-map {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Prevent zoom on double tap for map */
        #community-map {
            touch-action: manipulation;
        }

        /* Better vertex editing on mobile */
        .leaflet-pm-edit-marker {
            transform: scale(1.3) !important;
        }
    `;
    document.head.appendChild(style);

    // Add viewport meta tag for better mobile handling
    if (!document.querySelector('meta[name="viewport"][content*="user-scalable=no"]')) {
        const viewport = document.createElement('meta');
        viewport.name = 'viewport';
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        document.head.appendChild(viewport);
    }
}
</script>

</body></html>